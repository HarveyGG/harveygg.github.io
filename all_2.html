<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>  
	  
  	Harvey's Tech Site
  	
	</title>

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="atom.xml" rel="alternate" title="Harvey's Tech Site" type="application/atom+xml">

	<link href="asset/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="asset/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<script src="asset/javascripts/jquery.min.js"></script>
	

	<!--[if lt IE 9]><script src="asset/javascripts/html5.js"></script><![endif]-->
	<!-- <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> -->
	<style type="text/css">
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 300;
  src: local('Nunito-Light'), url(asset/font/1TiHc9yag0wq3lDO9cw0voX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 400;
  src: local('Nunito-Regular'), url(asset/font/6TbRXKWJjpj6V2v_WyRbMX-_kf6ByYO6CLYdB4HQE-Y.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 700;
  src: local('Nunito-Bold'), url(asset/font/TttUCfJ272GBgSKaOaD7KoX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
	</style>
	
	<style type="text/css">
	.container .left-col{ opacity: 1;}
	#pagenavi a{ font-size: 1.3em;}
	#pagenavi .next:before{ top: 3px;}
	#pagenavi .prev:before{ top: 3px;}
	.container .mid-col .mid-col-container #content .archives .title{ font-size: 1.5em;}
	.container .mid-col .mid-col-container #content article{ padding: 15px 0px;}
	#header .subtitle {
		line-height: 1.2em;
		padding-top: 8px;
	}
	article pre{ background: none; border: none; padding: 0;}
	article .entry-content{text-align: left;}
	.share-comment{ padding: 25px 0px; clear: both;}
	hr{ margin: 20px 0px;border: 0; border-top:solid 1px #ddd;}
	</style>
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner">
				 
				 	<div class="profilepic">
						<img src="https://i.imgur.com/fZFLeWH.jpg" style="width:160px;">
					</div>
            	
					
					<h1><a href="index.html">Harvey's Tech Site</a></h1>
					<p class="subtitle">More than 10 years backend development experience in e-commerce field. More than 3 years tech leader and frontend development experience. Proficient practical experience in DDD，Cloud-Native Development and DevOps。Focusing on ML&AI. Interested in web3 and metaverse.</p>
					<nav id="main-nav">
						<ul class="main">
						
						  <li id=""><a target="_self" href="index.html">Home</a></li>
						
						  <li id=""><a target="_self" href="echo-flow">EchoFlow</a></li>
						
						  <li id=""><a target="_self" href="mac-dev-env.html">MAC开发环境</a></li>
						
						  <li id=""><a target="_self" href="internet-tech.html">互联网技术</a></li>
						
						  <li id=""><a target="_self" href="architecture-designing.html">架构设计</a></li>
						
						  <li id=""><a target="_self" href="dev-ops">DevOps</a></li>
						
						  <li id=""><a target="_blank" href="resume.html">My Resume</a></li>
						
						  <li id=""><a target="_blank" href="publishing.html">关于网站发布</a></li>
						
						</ul>
					</nav>

					<nav id="sub-nav">
						<div class="social">




<a target="_blank" class="linkedin" href="https://www.linkedin.com/in/luckyowl" title="LinkedIn">LinkedIn</a>




<a target="_blank" class="twitter" target="_blank" href="https://twitter.com/Harvey_DDD" title="Twitter">Twitter</a>
<a target="_blank" class="github" target="_blank" href="https://github.com/HarveyGG" title="GitHub">GitHub</a>
<a target="_blank" class="email" href="mailto:harvey.wanghy@gmail.com" title="Email">Email</a>

								

								<a class="rss" href="atom.xml" title="RSS">RSS</a>
							
						</div>
					</nav>
				</header>				
			</div>
		</div>	
		<div class="mid-col">
			<div class="mid-col-container"> <div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2025-05-30T10:03:58-07:00" itemprop="datePublished">05/30/2025</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='architecture-designing.html'>架构设计</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="17486246383383.html" itemprop="url">
		DDD项目目录结构示例</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<pre><code class="language-plain_text">ecommerce-platform/
├── README.md
├── docker-compose.yml
├── requirements.txt
└── src/
    ├── shared/                           # 共享内核
    │   ├── __init__.py
    │   ├── domain/
    │   │   ├── __init__.py
    │   │   ├── base_entity.py
    │   │   ├── base_aggregate_root.py
    │   │   ├── domain_event.py
    │   │   ├── value_objects/
    │   │   │   ├── __init__.py
    │   │   │   ├── money.py
    │   │   │   ├── email.py
    │   │   │   └── phone.py
    │   │   └── exceptions/
    │   │       ├── __init__.py
    │   │       ├── domain_exception.py
    │   │       └── business_rule_violation.py
    │   ├── infrastructure/
    │   │   ├── __init__.py
    │   │   ├── database/
    │   │   │   ├── __init__.py
    │   │   │   ├── base_repository.py
    │   │   │   └── unit_of_work.py
    │   │   ├── messaging/
    │   │   │   ├── __init__.py
    │   │   │   ├── event_bus.py
    │   │   │   └── message_broker.py
    │   │   └── utils/
    │   │       ├── __init__.py
    │   │       ├── id_generator.py
    │   │       └── datetime_utils.py
    │   └── application/
    │       ├── __init__.py
    │       ├── base_command.py
    │       ├── base_query.py
    │       └── base_application_service.py
    │
    ├── core_domains/                     # 核心域
    │   ├── __init__.py
    │   │
    │   ├── catalog/                      # 核心域1：商品目录域
    │   │   ├── __init__.py
    │   │   ├── bounded_contexts/
    │   │   │   ├── __init__.py
    │   │   │   │
    │   │   │   ├── product_management/   # 限界上下文1：商品管理
    │   │   │   │   ├── __init__.py
    │   │   │   │   ├── domain/
    │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   ├── aggregates/
    │   │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   │   ├── product/         # 聚合1：商品聚合
    │   │   │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   │   │   ├── product.py           # 聚合根
    │   │   │   │   │   │   │   ├── product_variant.py   # 实体
    │   │   │   │   │   │   │   ├── product_attribute.py # 值对象
    │   │   │   │   │   │   │   └── product_specification.py # 规约
    │   │   │   │   │   │   ├── category/        # 聚合2：分类聚合
    │   │   │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   │   │   ├── category.py          # 聚合根
    │   │   │   │   │   │   │   ├── category_hierarchy.py # 值对象
    │   │   │   │   │   │   │   └── category_rules.py    # 领域服务
    │   │   │   │   │   │   └── brand/           # 聚合3：品牌聚合
    │   │   │   │   │   │       ├── __init__.py
    │   │   │   │   │   │       ├── brand.py             # 聚合根
    │   │   │   │   │   │       ├── brand_authorization.py # 实体
    │   │   │   │   │   │       └── brand_policy.py      # 值对象
    │   │   │   │   │   ├── value_objects/
    │   │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   │   ├── product_id.py
    │   │   │   │   │   │   ├── sku.py
    │   │   │   │   │   │   ├── price.py
    │   │   │   │   │   │   └── weight.py
    │   │   │   │   │   ├── entities/
    │   │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   │   └── product_review.py
    │   │   │   │   │   ├── domain_services/
    │   │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   │   ├── product_validation_service.py
    │   │   │   │   │   │   └── pricing_service.py
    │   │   │   │   │   ├── repositories/
    │   │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   │   ├── product_repository.py
    │   │   │   │   │   │   ├── category_repository.py
    │   │   │   │   │   │   └── brand_repository.py
    │   │   │   │   │   └── events/
    │   │   │   │   │       ├── __init__.py
    │   │   │   │   │       ├── product_created.py
    │   │   │   │   │       ├── product_updated.py
    │   │   │   │   │       └── product_discontinued.py
    │   │   │   │   ├── application/
    │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   ├── commands/
    │   │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   │   ├── create_product_command.py
    │   │   │   │   │   │   ├── update_product_command.py
    │   │   │   │   │   │   └── discontinue_product_command.py
    │   │   │   │   │   ├── queries/
    │   │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   │   ├── get_product_query.py
    │   │   │   │   │   │   └── search_products_query.py
    │   │   │   │   │   ├── handlers/
    │   │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   │   ├── product_command_handler.py
    │   │   │   │   │   │   └── product_query_handler.py
    │   │   │   │   │   └── services/
    │   │   │   │   │       ├── __init__.py
    │   │   │   │   │       └── product_application_service.py
    │   │   │   │   ├── infrastructure/
    │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   ├── persistence/
    │   │   │   │   │   │   ├── __init__.py
    │   │   │   │   │   │   ├── sqlalchemy_product_repository.py
    │   │   │   │   │   │   ├── sqlalchemy_category_repository.py
    │   │   │   │   │   │   └── models/
    │   │   │   │   │   │       ├── __init__.py
    │   │   │   │   │   │       ├── product_model.py
    │   │   │   │   │   │       └── category_model.py
    │   │   │   │   │   └── external_services/
    │   │   │   │   │       ├── __init__.py
    │   │   │   │   │       └── image_service.py
    │   │   │   │   └── presentation/
    │   │   │   │       ├── __init__.py
    │   │   │   │       ├── api/
    │   │   │   │       │   ├── __init__.py
    │   │   │   │       │   ├── product_controller.py
    │   │   │   │       │   └── category_controller.py
    │   │   │   │       └── dto/
    │   │   │   │           ├── __init__.py
    │   │   │   │           ├── product_dto.py
    │   │   │   │           └── category_dto.py
    │   │   │   │
    │   │   │   └── inventory_management/     # 限界上下文2：库存管理
    │   │   │       ├── __init__.py
    │   │   │       ├── domain/
    │   │   │       │   ├── __init__.py
    │   │   │       │   ├── aggregates/
    │   │   │       │   │   ├── __init__.py
    │   │   │       │   │   └── inventory/
    │   │   │       │   │       ├── __init__.py
    │   │   │       │   │       ├── inventory.py
    │   │   │       │   │       ├── stock_movement.py
    │   │   │       │   │       └── reorder_policy.py
    │   │   │       │   └── repositories/
    │   │   │       │       ├── __init__.py
    │   │   │       │       └── inventory_repository.py
    │   │   │       ├── application/
    │   │   │       └── infrastructure/
    │   │   └── shared/                   # 该域内共享
    │   │       ├── __init__.py
    │   │       └── catalog_shared_types.py
    │   │
    │   └── trading/                      # 核心域2：交易域
    │       ├── __init__.py
    │       ├── bounded_contexts/
    │       │   ├── __init__.py
    │       │   ├── order_management/     # 订单管理上下文
    │       │   │   ├── __init__.py
    │       │   │   ├── domain/
    │       │   │   │   ├── aggregates/
    │       │   │   │   │   ├── order/
    │       │   │   │   │   │   ├── order.py
    │       │   │   │   │   │   ├── order_item.py
    │       │   │   │   │   │   └── order_status.py
    │       │   │   │   │   └── shopping_cart/
    │       │   │   │   │       ├── cart.py
    │       │   │   │   │       └── cart_item.py
    │       │   │   │   └── repositories/
    │       │   │   │       └── order_repository.py
    │       │   │   ├── application/
    │       │   │   ├── infrastructure/
    │       │   │   └── presentation/
    │       │   └── payment_processing/   # 支付处理上下文
    │       │       ├── __init__.py
    │       │       ├── domain/
    │       │       ├── application/
    │       │       ├── infrastructure/
    │       │       └── presentation/
    │       └── shared/
    │           ├── __init__.py
    │           └── trading_shared_types.py
    │
    └── supporting_domains/               # 支撑域
        ├── __init__.py
        └── user_management/              # 支撑域：用户管理域
            ├── __init__.py
            ├── bounded_contexts/
            │   ├── __init__.py
            │   ├── authentication/       # 认证上下文
            │   │   ├── __init__.py
            │   │   ├── domain/
            │   │   │   ├── aggregates/
            │   │   │   │   └── user/
            │   │   │   │       ├── user.py
            │   │   │   │       ├── user_credential.py
            │   │   │   │       └── login_session.py
            │   │   │   └── repositories/
            │   │   │       └── user_repository.py
            │   │   ├── application/
            │   │   ├── infrastructure/
            │   │   └── presentation/
            │   └── profile_management/   # 用户档案管理上下文
            │       ├── __init__.py
            │       ├── domain/
            │       ├── application/
            │       ├── infrastructure/
            │       └── presentation/
            └── shared/
                ├── __init__.py
                └── user_shared_types.py
</code></pre>
<h2><a id="%E5%85%B3%E9%94%AE%E8%AE%BE%E8%AE%A1%E8%AF%B4%E6%98%8E" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>关键设计说明</h2>
<h3><a id="1%E5%9F%9F%E7%9A%84%E5%88%86%E5%B1%82" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. 域的分层</h3>
<ul>
<li><strong>core_domains/</strong>: 核心域，企业的核心竞争力</li>
<li><strong>supporting_domains/</strong>: 支撑域，支持核心业务</li>
<li><strong>shared/</strong>: 共享内核，跨域共享的基础设施</li>
</ul>
<h3><a id="2%E9%99%90%E7%95%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E4%BD%93%E7%8E%B0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. 限界上下文的体现</h3>
<p>在 <code>catalog</code> 核心域中：</p>
<ul>
<li><strong>product_management</strong>: 商品管理上下文</li>
<li><strong>inventory_management</strong>: 库存管理上下文</li>
</ul>
<p>每个上下文都有完整的分层架构。</p>
<h3><a id="3%E8%81%9A%E5%90%88%E7%9A%84%E7%BB%84%E7%BB%87" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. 聚合的组织</h3>
<p>在 <code>product_management</code> 上下文的 <code>domain/aggregates/</code> 中：</p>
<ul>
<li><strong>product/</strong>: 商品聚合（包含商品、商品变体等）</li>
<li><strong>category/</strong>: 分类聚合（包含分类层次结构）</li>
<li><strong>brand/</strong>: 品牌聚合（包含品牌授权等）</li>
</ul>
<h3><a id="4%E5%AE%8C%E6%95%B4%E7%9A%84-ddd%E5%88%86%E5%B1%82" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4. 完整的DDD分层</h3>
<p>每个限界上下文都包含：</p>
<ul>
<li><strong>Domain Layer</strong>: 聚合、实体、值对象、领域服务</li>
<li><strong>Application Layer</strong>: 应用服务、命令/查询处理器</li>
<li><strong>Infrastructure Layer</strong>: 持久化、外部服务适配</li>
<li><strong>Presentation Layer</strong>: API控制器、DTO</li>
</ul>
<h3><a id="5%E4%BE%9D%E8%B5%96%E6%96%B9%E5%90%91" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>5. 依赖方向</h3>
<pre><code class="language-plain_text">Presentation → Application → Domain ← Infrastructure
</code></pre>
<p>依赖始终指向内层，符合洋葱架构原则。</p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2021-02-26T15:25:54-08:00" itemprop="datePublished">02/26/2021</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='architecture-designing.html'>架构设计</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="16143819545361.html" itemprop="url">
		各种Branching Model，workflow的比较思路和推荐小团队使用的精简有效的workflow</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h2><a id="%E4%B8%80%E3%80%81%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9E%8B%E9%80%89%E5%9E%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>一、分支管理模型选型</h2>
<p>Branching Model在业界有多种规范，如：<a href="https://nvie.com/posts/a-successful-git-branching-model/">Gitflow</a>、AoneFlow、<a href="https://www.endoflineblog.com/oneflow-a-git-branching-model-and-workflow">OneFlow</a>等，Branching Model的复杂程度取决于实际开发团队和代码规模，自动化程度等因素，实际使用时需要结合当前具体情况精简。但随着情况变化，当前的Model可能会不适用，需要定期Review并优化模型选型。</p>
<h2><a id="%E4%BA%8C%E3%80%81branching-model%E7%9A%84%E9%80%89%E5%9E%8B%E4%BE%9D%E6%8D%AE%E5%8F%82%E8%80%83" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>二、Branching Model的选型依据参考</h2>
<ol>
<li>是否一个Repository同时有多人在分别开发不同feature，或者做bugfix，且需要同时deploy到不同环境。eg. dev, pre, production, grayscale etc.
<ul>
<li>解决方案：每个环境需要一个对应的branch或tag</li>
</ul>
</li>
<li>是否需要同时维护多个长期版本
<ul>
<li>解决方案：需要多个base branch</li>
</ul>
</li>
<li>是否需要一个branch来记录latest stable version，这个version和production environment上deploy的内容完全一致
<ul>
<li>解决方案：需要一个mark branch</li>
</ul>
</li>
<li>是否需要在发布新版本到生产环境前冻结代码进行控制
<ul>
<li>解决方案：需要对应一个branch，此branch开发无权限merge，代码被merge到此branch之后开始做集成测试</li>
</ul>
</li>
<li>是否有CI/CD自动化工具
<ul>
<li>解决方案：CI/CD自动化工具可以简化开发对git的操作</li>
</ul>
</li>
</ol>
<h2><a id="%E4%B8%89%E3%80%81%E5%B0%8F%E5%9E%8B%E5%9B%A2%E9%98%9F%E9%80%89%E5%9E%8B%E7%BB%93%E8%AE%BA" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>三、小型团队选型结论</h2>
<ol>
<li>存在多个开发在一个Repository上开发不同feature然后合并到一起测试和同时deploy到production environment的场景</li>
<li>不需要维护多个长期版本</li>
<li>不需要一个单端的branch来记录production environment上deploy的内容</li>
<li>不必要deploy前冻结代码</li>
<li>无CI/CD自动化工具</li>
</ol>
<h3><a id="%E7%BB%93%E8%AE%BA%EF%BC%9A" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>结论：</h3>
<p>用到的branch（尽量少）：</p>
<ul>
<li>develop branch</li>
<li>release branch</li>
<li>feature branch</li>
</ul>
<h2><a id="%E5%9B%9B%E3%80%81branching-model-workflow" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>四、branching model &amp; workflow</h2>
<ul>
<li>使用long live的develop branch来记录最新的代码</li>
<li>使用short live的release branch来记录next version的代码，并且使用release branch部署test和production environment</li>
<li>使用Tag来记录latest的production environment内容</li>
<li>在最新的Tag上创建short live的bugfix branch用来修production environment的bug</li>
</ul>
<p>具体的workflow如下：</p>
<h3><a id="4-1-working-on-a-feature-branch" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.1 working on a feature branch</h3>
<ol>
<li>Fetch develop branch so as to make it up to date</li>
</ol>
<pre><code class="language-plain_text">$ git fetch develop
</code></pre>
<ol start="2">
<li>Start a new feature branch</li>
</ol>
<pre><code class="language-plain_text">$ git checkout -b feature/${customized_feature_name} origin/develop
</code></pre>
<ol start="3">
<li>Implement feature and commit several times</li>
</ol>
<pre><code class="language-plain_text">$ git commit -a --amend
</code></pre>
<ol start="4">
<li>Merge with latest develop branch</li>
</ol>
<pre><code class="language-plain_text">$ git fetch develop
$ git rebase origin/develop
</code></pre>
<ol start="5">
<li>Self-testing</li>
<li>Push your branch. Make sure you have only one commit for your feature before push</li>
</ol>
<pre><code class="language-plain_text">$ git log
$ git rebase -i hash
$ git push origin feature/${customized_feature_name}
</code></pre>
<ol start="7">
<li>Open your browser and visit the &quot;pull request url&quot; printed on your console, then finish committing a PR on your browser with detailed test cases in your comment.</li>
</ol>
<h3><a id="4-2-working-on-a-release-branch" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.2 working on a release branch</h3>
<p>You need a release branch when you decide to deploy a new release to production environment.</p>
<ol>
<li>Fetch develop branch so as to make it up to date</li>
</ol>
<pre><code class="language-plain_text">$ git fetch develop
</code></pre>
<ol start="2">
<li>Start a release branch</li>
</ol>
<pre><code class="language-plain_text">$ git log origin/develop
$ git checkout -b release/x.y.z hash
</code></pre>
<ol start="3">
<li>Deploy to test environment based on release/x.y.z branch</li>
<li>Test thoroughly &amp; Bug fixing(There should be only one commit for all bugs)</li>
<li>Deploy to production environment based on release/x.y.z branch's latest commit &amp; Test</li>
<li>Squash commits &amp; Tag the commit</li>
</ol>
<pre><code class="language-plain_text">$ git rebase -i hash
$ git tag x.y.z
</code></pre>
<ol start="7">
<li>Merge to develop branch and push</li>
</ol>
<pre><code class="language-plain_text">$ git checkout develop
$ git pull origin develop
$ git merge release/x.y.z
$ git push --tags origin develop
$ git branch -d release/x.y.z
</code></pre>
<h3><a id="4-3-working-on-a-hotfix-branch" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.3 working on a hotfix branch</h3>
<ol>
<li>Start a bugfix branch</li>
</ol>
<pre><code class="language-plain_text">$ git checkout -b hotfix/x.y.1 x.y.0
</code></pre>
<ol>
<li>Code and fix bugs</li>
<li>Finish a bugfix branch</li>
</ol>
<pre><code class="language-plain_text">$ git checkout develop
$ git pull origin develop
$ git merge hotfix/x.y.1
$ git push --tags origin develop
$ git branch -d hotfix/x.y.1
</code></pre>
<p>rebase -i用法参考</p>
<blockquote>
<p><a href="https://git-scm.com/book/en/v2/Git-Tools-Rewriting-History">Rewriting History Chapter from Pro Git SCM book</a></p>
</blockquote>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-12-23T18:29:27-08:00" itemprop="datePublished">12/23/2019</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='architecture-designing.html'>架构设计</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15771545679019.html" itemprop="url">
		DDD学习笔记</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h2><a id="%E4%BB%80%E4%B9%88%E6%98%AF%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>什么是领域驱动</h2>
<h3><a id="%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E9%A9%B1%E5%8A%A8" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>数据模型驱动</h3>
<p>传统服务建模的过程是先通过业务分析数据模型，然后在关系型数据库上基于范式设计数据库表以及表之间的关系。最后通过ORM建立起数据持久化对象和数据库表之间的映射。还要通过数据访问对象(DAO)来操作数据持久化对象。</p>
<p>由于持久化对象和数据访问对象都不包含业务逻辑，服务就成为了业务逻辑的唯一栖身之地。这时，持久化对象是数据的提供者，实现服务时就会非常自然地选择事务脚本（Transaction Script）模式。</p>
<p>《企业应用架构模式》对事务脚本的定义为：</p>
<blockquote>
<p>使用过程来组织业务逻辑，每个过程处理来自表现层的单个请求。这是一种典型的过程式设计，每个服务功能都是一系列步骤的组合，从而形成一个完整的事务。注意，这里的事务代表一个完整的业务行为过程，而非保证数据一致性的事务概念。</p>
</blockquote>
<p>不要因为事务脚本采用面向过程设计就排斥这一模式，相较于对编程范式的偏执，我认为 Martin Fowler 在书中说的一句话更加公道：</p>
<blockquote>
<p>“不管你是多么坚定的面向对象的信徒，也不要盲目排斥事务脚本。许多问题本身是简单的，一个简单的解决方案可以加快你的开发速度，而且运行起来也会更快。”</p>
</blockquote>
<p>即使采用事务脚本，我们也可以通过提取方法来改进代码的可读性。每个方法都提供了一定的抽象层次，通过方法的提取就可以在一定程度上隐藏细节，保持合理的抽象层次。这种方式被 Kent Beck 总结为组合方法（Composed Method）模式：</p>
<ul>
<li>把程序划分为方法，每个方法执行一个可识别的任务</li>
<li>让一个方法中的所有操作处于相同的抽象层</li>
<li>这会自然地产生包含许多小方法的程序，每个方法只包含少量代码</li>
</ul>
<h3><a id="%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1%E9%A9%B1%E5%8A%A8" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>领域建模驱动</h3>
<p>领域建模驱动是相对于数据建模驱动的。<br />
领域建模驱动要先识别出领域，确定领域模型，然后再确定技术实现方案。<br />
识别领域确定领域模型的过程需要分析清楚问题域，理清业务。所以领域驱动设计倡导的是从问题出发，先分析问题域得到业务，然后结合业务、规模、系统结构进行设计，然后再编码实现。</p>
<ul>
<li>问题域——客户的需求</li>
<li>解决方案域——需求的实现</li>
</ul>
<pre><code class="language-plain_text">问题-&gt;领域-&gt;业务逻辑-&gt;规模-&gt;结构-&gt;实现
</code></pre>
<h2><a id="ddd%E4%B8%BA%E4%BB%80%E4%B9%88%E7%AA%81%E7%84%B6%E7%81%AB%E4%BA%86" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>DDD为什么突然火了</h2>
<p>微服务的划分粒度如何把握。</p>
<blockquote>
<p>纵观软件设计的历史，不是分久必合、合久必分，而是不断拆分、持续拆分的微型化过程。</p>
</blockquote>
<p>限界上下文(Bounded Context)有利于确定微服务的划分。</p>
<p>理论上：</p>
<ul>
<li>一个微服务不要小于一个聚合</li>
<li>一个微服务不要大于一个限界上下文</li>
</ul>
<p>如果出现如下情况说明微服务划分不合理：</p>
<ul>
<li>微服务间经常需要分布式事务来支持业务数据一致性</li>
<li>对于微服务A来说，处理一个请求总是依赖另一个微服务B</li>
<li>一个微服务中出现多个名字相同的领域实体</li>
</ul>
<h2><a id="ddd%E7%9A%84%E4%BB%B7%E5%80%BC" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>DDD的价值</h2>
<blockquote>
<p>应对软件复杂度</p>
</blockquote>
<ul>
<li>从领域出发，保证软件分析模型和设计模型一致，业务人员和开发协作，保证软件质量</li>
<li>提出统一语言，确保所有概念在各自的上下文中清晰无歧义</li>
<li>提出分层架构，有效分离业务和技术，同时从垂直方向上做分隔职责边界</li>
<li>战略设计通过拆分子域和限界上下文，从横向上分隔离职责边界</li>
<li>战术设计通过引入多种领域模型概念帮助领域模型设计落地</li>
<li>引入微服务间协作的设计模式</li>
</ul>
<h3><a id="%E8%BD%AF%E4%BB%B6%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E5%A4%8D%E6%9D%82" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>软件为什么会复杂</h3>
<p>主观可控：</p>
<ul>
<li>业务规则 <em>复杂</em></li>
<li>需求变化 <em>不可预测</em></li>
<li>规模变 <em>大</em></li>
<li>结构变 <em>复杂</em></li>
<li>技术选型 <em>升级</em></li>
</ul>
<p>主观不可控：</p>
<ul>
<li>人不够</li>
<li>人员流动</li>
<li>时间紧</li>
<li>组织架构不合理</li>
</ul>
<h3><a id="%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%E8%BD%AF%E4%BB%B6%E5%A4%8D%E6%9D%82" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>如何应对软件复杂</h3>
<p><strong>关注点分离（Separation of Concern）</strong></p>
<ul>
<li>分离业务和技术
<ul>
<li>分层架构
<ul>
<li>六边形架构</li>
<li>整洁架构</li>
</ul>
</li>
<li>分层
<ul>
<li>UI层（User Interface Layer）</li>
<li>应用层（Application Layer）</li>
<li>领域层（Domain Layer）</li>
<li>技术设施层（Infrastructure Layer）</li>
</ul>
</li>
<li>设计原则
<ul>
<li>SRP (Single-Responsibility Principle)</li>
<li>DIP (Dependency inversion principle)</li>
<li>Interface-Oriented Programming</li>
<li>Dependency Injection</li>
</ul>
</li>
</ul>
</li>
<li>分离职责
<ul>
<li>限界上下文</li>
<li>聚合</li>
<li>领域</li>
</ul>
</li>
</ul>
<p><img src="media/15771545679019/15771737688932.jpg" alt="" /></p>
<p><img src="media/15771545679019/15771749354517.jpg" alt="" /></p>
<h2><a id="ddd%E7%9A%84%E8%AE%BE%E8%AE%A1%E8%BF%87%E7%A8%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>DDD的设计过程</h2>
<p><img src="media/15771545679019/15771554676189.jpg" alt="" /></p>
<h3><a id="%E6%88%98%E7%95%A5%E8%AE%BE%E8%AE%A1%E9%98%B6%E6%AE%B5" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>战略设计阶段</h3>
<ul>
<li>问题域
<ul>
<li>限界上下文（Bounded Context）</li>
<li>上下文映射（Context Map）</li>
<li>核心域（Core Domain）</li>
<li>子域（Subdomain）</li>
</ul>
</li>
<li>架构
<ul>
<li>六边形架构</li>
<li>整洁架构</li>
<li>CQRS</li>
<li>Event Sourcing</li>
</ul>
</li>
</ul>
<h3><a id="%E6%88%98%E6%9C%AF%E8%AE%BE%E8%AE%A1%E9%98%B6%E6%AE%B5" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>战术设计阶段</h3>
<ul>
<li>值对象（Value Object）</li>
<li>实体（Entity）</li>
<li>领域服务（Domain Service）</li>
<li>领域事件（Domain Event）</li>
<li>资源库（Repository）</li>
<li>工厂（Factory）</li>
<li>聚合（Aggregate）</li>
<li>应用服务（Application Service）</li>
</ul>
<p><img src="media/15771545679019/15771569102713.jpg" alt="" /></p>
<h3><a id="%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>一个完整的生命周期</h3>
<table>
<thead>
<tr>
<th>阶段</th>
<th>参与者</th>
<th>产出物</th>
</tr>
</thead>
<tbody>
<tr>
<td>需求</td>
<td>产品经理、客户</td>
<td>需求文档</td>
</tr>
<tr>
<td>KickOff</td>
<td>产品经理、客户、开发负责人、测试负责人</td>
<td>明确利益相关人、对业务的共同理解、识别主要用户故事</td>
</tr>
<tr>
<td>事件风暴</td>
<td>领域专家、产品经理、DDD专家、架构师、相关开发</td>
<td>统一语言、领域模型</td>
</tr>
<tr>
<td>架构设计</td>
<td>架构师、DDD专家</td>
<td>代码包结构、技术选型、系统间通信方式</td>
</tr>
<tr>
<td>开发</td>
<td>架构师、开发</td>
<td>单元测试、代码实现</td>
</tr>
<tr>
<td>演示</td>
<td>产品经理、开发负责人、测试负责人、领域专家、客户</td>
<td>客服意见</td>
</tr>
<tr>
<td>测试</td>
<td>测试</td>
<td>测试报告</td>
</tr>
<tr>
<td>交付</td>
<td>运维、开发、测试</td>
<td>服务</td>
</tr>
</tbody>
</table>
<h2><a id="%E9%A2%86%E5%9F%9F%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%8F%90%E7%82%BC" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>领域模型的提炼</h2>
<p><img src="media/15771545679019/15776877632436.jpg" alt="" /></p>
<h3><a id="6w%E6%A8%A1%E5%9E%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>6W模型</h3>
<ul>
<li>Who: 角色，一个场景中参与的用户是什么角色</li>
<li>Why: 价值，解决用户什么问题</li>
<li>What: 功能，需要做什么</li>
<li>When: 流程，具体的业务逻辑是什么</li>
<li>Where: 边界，场景的边界</li>
<li>How: 实现，具体的技术实现</li>
</ul>
<h3><a id="%E5%A6%82%E4%BD%95%E5%AE%9E%E6%96%BD6w%E6%A8%A1%E5%9E%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>如何实施6W模型</h3>
<h4><a id="1%E7%94%A8%E4%BE%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. 用例</h4>
<pre><code class="language-plain_text">用例名称：批量增加主机
用例目的（Why）：本用例可以帮助「角色（Who）」为其微服务一次性关联（What）符合「条件」的主机
参与者（Who）：「角色」
前置条件：微服务已经被纳管

基础流程（When）：
1. ……
2. ……
3. ……

替代流程：异常情况一
替代流程：异常情况二
</code></pre>
<h4><a id="2-tdd" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. TDD</h4>
<pre><code class="language-java">@Autowared
private HostAppService hostAppService;

@Test
// 测试方法以描述业务的形式命名
// 不要对被测试方法写单元测试，要对领域场景编写，驱动我们识别场景分解任务
public void should_return_100_when_100_valid_hosts_registered_successfully() {
    // given 驱动我们思考对象的创建，与其他对象的协作，领域对象的命名（统一语言）
    Microservice microservice = Mock.one(Microservice.class);
    List&lt;Host&gt; validHosts = validHosts(100);
    
    // when 驱动我们思考职责边界、方法的命名、入参
    int successAmount = hostAppService.registerHostsForMicroservice(microservice, validHosts)
}
    
    // then 驱动我们思考方法的返回值、对系统的其他影响
    AssertThat(successAmount, is(100));
</code></pre>
<h2><a id="%E7%BB%9F%E4%B8%80%E8%AF%AD%E8%A8%80" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>统一语言</h2>
<ul>
<li>通过事件风暴获得统一语言的中文</li>
<li>标注对应英文</li>
<li>引入局外人对用例的阐述进行提问</li>
<li>统一语言要具备专业性（水，H2O）</li>
</ul>
<h2><a id="%E9%99%90%E7%95%8C%E4%B8%8A%E4%B8%8B%E6%96%87" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>限界上下文</h2>
<p>限界上下文需要满足四个特征：</p>
<ul>
<li>最小完备：要完备，而且要最小；不依赖外部</li>
<li>自我履行：知识专家，基于掌握的知识决定需要履行的职责，不做边界外的职责</li>
<li>稳定空间：分离内外，外部变化对内不影响</li>
<li>独立进化：自身进化对外不影响</li>
</ul>
<h3><a id="%E8%AF%86%E5%88%AB%E9%99%90%E7%95%8C%E4%B8%8A%E4%B8%8B%E6%96%87" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>识别限界上下文</h3>
<p>识别限界上下文就是寻找边界：基于业务边界、技术边界，找到限界上下文的边界，进而找到工作边界、应用边界。</p>
<p><img src="media/15771545679019/15785351896389.jpg" alt="" /></p>
<h3><a id="%E9%AA%8C%E8%AF%81%E8%AF%86%E5%88%AB%E7%BB%93%E6%9E%9C" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>验证识别结果</h3>
<ul>
<li>是否能给限界上下文轻松的命名</li>
<li>限界上下文之间是否容易协作</li>
</ul>
<h3><a id="%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8D%8F%E4%BD%9C%E5%85%B3%E7%B3%BB" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>上下文协作关系</h3>
<p><img src="media/15771545679019/15794115154549.jpg" alt="" /></p>
<p>上下文映射模式：</p>
<ol>
<li>合作关系（Partnership）</li>
<li>共享内核（Shared Kernel）</li>
<li>客户方-供应方开发（Customer-Supplier Development）</li>
<li>遵奉者（Conformist）</li>
<li>分离方式（Separate Ways）</li>
</ol>
<p>降低上下文之间耦合的模式：</p>
<ol>
<li>防腐层（Anticorruption Layer）</li>
<li>开放主机服务（Open Host Service）</li>
<li>发布/订阅事件</li>
</ol>
<p>附：《实现领域驱动设计》里的9种组织模式和集成模式</p>
<pre><code class="language-plain_text">①合作关系（Partnership）

如果2个限界上下文的团队要么一起成功，要么一起失败，此时就是这种关系。应该为相互关联的软件功能制定好计划表，这样可以确保这些功能在同一个发布中完成。

②共享内核（Shared Kernel）
   
对模型和代码的共享将产生一种紧密的依赖性，对于设计来说，这种依赖性可好可坏。我们需要为共享的部分模型指定一个显式边界，并保持共享内核的小型化。共享内核具有特殊的状态，在没有与另一个团队协商的情况下，这种状态是不能改变的。我们应该引入一种持续集成过程来保证共享内核与通用语言的一致性。

③客户方——供应方（Customer-Supplier Development）

当2个团队处于一种上游——下游关系时，上游团队可能独立于下游团队完成开发，此时下游团队的开发可能会受到很大的影响。因此，在上游团队的计划中，我们应该顾及到下游团队的需求。

④遵奉者（Conformist）

在存在上游——下游关系的2个团队中，如果上游团队已经没有动力提供下游团队之需，下游团队便孤军无助了。处于利他主义，上游团队可能向下游团队做出种种承诺，但是有很大的可能是：这些承诺是无法实现的。下游团队只能盲目地使用上游团队模型。

⑤防腐层（Anticorruption Layer）

在集成2个设计良好的限界上下文时，翻译层可能很简单，甚至可以很优雅的实现。但是，当共享内核，合作关系或客户方——供应方关系无法顺利实现时，此时的翻译将变得复杂。对于下游客户来说，你需要根据自己的领域模型创建一个单独的层，该层作为上游系统的委派向你的系统提供功能。防腐层通过已有的接口与其他系统交互，而其他系统只需要做很小的修改，甚至无需修改。在防腐层内部，它在你自己的模型和他方模型之间进行翻译转换。【为每个防腐层定义相应的领域服务】

⑥开放主机服务（Open Host Service）

定义一种协议，让你的子系统通过该协议来访问你的服务。并且需要将协议公开。

⑦发布语言（Published Language）

在2个限界上下文之间翻译模型需要一种公用的语言。此时你应该使用一种发布出来的共享语言来完成集成交流。发布语言通常与开放主机服务一起使用。

⑧另谋他路（SeparateWay）

在确定需求时，我们应该做到坚持彻底。如果2套功能没有显著的关系，那么它们是可以被完全解耦的。集成总是昂贵的，有时带给你的好处也不大。声明2个限界上下文之间不存在任何关系，这样使得开发者去另外寻找简单的、专门的方法来解决问题。

⑨大泥球（Big Ball of Mud）

当我们检查已有系统时，经常会发现系统中存在混杂在一起的模型，它们之间的边界是非常模糊的。此时你应该为整个系统绘制一个边界，然后将其归纳在大泥球范围之列。在这个边界内，不要试图使用复杂的建模手段来化解问题。同时，这样的系统有可能会向其他系统蔓延，应该对此保持警觉。
</code></pre>
<h3><a id="%E5%88%92%E5%88%86%E5%9B%A2%E9%98%9F%E5%92%8C%E5%BA%94%E7%94%A8" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>划分团队和应用</h3>
<ul>
<li>基于语义相关性和功能相关性识别出限界上下文</li>
<li>基于<code>2PTs规则</code>、<code>特性团队</code>、<code>康威定律</code>思想划分团队，找到工作边界</li>
<li>基于<code>重用性</code>、<code>业务变化</code>、<code>质量属性</code>、<code>技术选型</code>等技术考虑划分应用边界，并持续重构</li>
</ul>
<h2><a id="%E6%88%98%E7%95%A5%E8%AE%BE%E8%AE%A1%E9%98%B6%E6%AE%B5%E4%BA%A7%E5%87%BA%E7%89%A9" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>战略设计阶段产出物</h2>
<ol>
<li>利益相关人</li>
<li>业务期望和愿景</li>
<li>项目业务范围</li>
<li>业务流程</li>
<li>史诗级故事和主故事</li>
<li>根据核心参与者识别用例，输出每个参与者的用例图</li>
<li>根据语义相关性和功能相关性识别出用例主题边界，输出用例主题</li>
<li>根据主题之间的相关性识别限界上下文</li>
<li>上下文映射图或表</li>
<li>输出架构4+1视图
<ol>
<li>逻辑视图：限界上下文图；上下文映射图；分层架构</li>
<li>进程视图：限界上下文图；六边形架构；上下文映射</li>
<li>物理视图：六边形架构</li>
<li>开发视图：分层架构；代码模型</li>
<li>场景视图：领域场景分析；用例图</li>
</ol>
</li>
</ol>
<h3><a id="%E6%9E%B6%E6%9E%844-1%E8%A7%86%E5%9B%BE%E4%B8%BE%E4%BE%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>架构4+1视图举例</h3>
<h4><a id="1%E9%80%BB%E8%BE%91%E8%A7%86%E5%9B%BE" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. 逻辑视图</h4>
<p><img src="media/15771545679019/15833010184246.jpg" alt="" /></p>
<p>视图说明</p>
<ul>
<li>系统层次的分层架构</li>
<li>限界上下文层次的分层架构</li>
</ul>
<h4><a id="2%E8%BF%9B%E7%A8%8B%E8%A7%86%E5%9B%BE" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. 进程视图</h4>
<p><img src="media/15771545679019/15833010852284.jpg" alt="" /></p>
<p>视图说明</p>
<ul>
<li>在绘制系统的进程视图时，不需要将每个牵涉到进程间调用的用例场景都展现出来，而是将这些参与协作的组件以抽象方式表达一个典型的全场景即可。</li>
<li>整个进程视图非常清晰地表达了部署在不同进程之上的组件或子系统之间的协作关系，同时通过图例体现了领域驱动设计中的北向网关和南向网关与外部资源之间的协作。调用的方式是同步还是异步，也一目了然。</li>
</ul>
<h4><a id="3%E7%89%A9%E7%90%86%E8%A7%86%E5%9B%BE" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. 物理视图</h4>
<p><img src="media/15771545679019/15833011711307.jpg" alt="" /></p>
<p>物理视图与进程视图虽然都以进程边界为主要的设计单元，但二者的关注点不同。进程视图是动态的，体现的是外部环境、系统各个组件在进程之间的协作方式与通信机制；物理视图是静态的，主要体现系统各个模块以及系统外部环境的部署位置与部署方式。</p>
<h4><a id="4%E5%BC%80%E5%8F%91%E8%A7%86%E5%9B%BE" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4. 开发视图</h4>
<p><img src="media/15771545679019/15833012202839.jpg" alt="" /></p>
<ul>
<li>给出代码分层结构</li>
<li>分别体现出系统级代码分层结构和限界上下文内的代码分层结构</li>
</ul>
<h2><a id="%E5%AE%9E%E4%BD%93" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>实体</h2>
<h2><a id="%E5%80%BC%E5%AF%B9%E8%B1%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>值对象</h2>
<h2><a id="%E8%81%9A%E5%90%88" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>聚合</h2>
<p>引入聚合来划分对象之间的边界，保证边界内所有对象的一致性。其中作为主体的实体对象是聚合根。</p>
<h3><a id="%E8%81%9A%E5%90%88%E8%BE%B9%E7%95%8C%E7%9A%84%E8%AF%86%E5%88%AB" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>聚合边界的识别</h3>
<ul>
<li>是否多实体同生命周期，同生同死组合关系（完整性）</li>
<li>是否单实体有独立性需求，外界需要直接和他交互（独立性）</li>
<li>是否存在不变量</li>
<li>是否处于一个事务中</li>
</ul>
<h3><a id="%E8%A7%84%E5%88%99" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>规则</h3>
<ul>
<li>外界只能和聚合根交互</li>
<li>聚合根可以向外部传递内部实体的引用，但外部对象只能临时使用</li>
<li>聚合根可以向外部传递值对象的副本</li>
<li>只有聚合根才能直接通过数据库获得，其他实体通过聚合根获得</li>
</ul>
<h2><a id="%E9%A2%86%E5%9F%9F%E6%9C%8D%E5%8A%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>领域服务</h2>
<p>存在跨聚合的业务场景时需要使用领域服务</p>
<h2><a id="%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>分层架构</h2>
<p>传统三层架构和领域驱动经典四层架构的对比：</p>
<p><img src="media/15771545679019/15802181588889.jpg" alt="" /><br />
经典三层架构</p>
<p><img src="media/15771545679019/15802181811457.jpg" alt="" /><br />
Eric Evans 在其经典著作《领域驱动设计》中的四层架构</p>
<ul>
<li>领域驱动四层架构多引入了<code>Application Layer</code></li>
<li><code>业务逻辑层</code>改名为<code>Domain Layer</code>，定位更具体</li>
<li><code>数据访问层</code>的名字变为<code>Infrastructure Layer</code>，职责扩大</li>
</ul>
<h3><a id="%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>对比分析</h3>
<p>优化后的分层架构通过引入<code>Application Layer</code>，使<code>Domain Layer</code>可以专注业务逻辑，不依赖外部环境，更内聚。<br />
<code>Infrastructure Layer</code>用来分离业务和技术关注点，并不只用来请求数据。</p>
<h3><a id="%E4%BC%A0%E7%BB%9F%E4%B8%89%E5%B1%82%E6%9E%B6%E6%9E%84%E5%8D%87%E7%BA%A7%E5%88%B0ddd%E5%9B%9B%E5%B1%82%E6%9E%B6%E6%9E%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>传统三层架构升级到DDD四层架构</h3>
<p><img src="media/15771545679019/15802218910157.jpg" alt="" /><br />
三层架构代码模型</p>
<p><img src="media/15771545679019/15802220571963.jpg" alt="" /><br />
把Java Beans变成充血模型的POJO，并迁移到业务逻辑层。此时POJO对应DDD的Entity和Value Object，业务逻辑层变为领域层。此时领域层和基础设施层相互依赖。</p>
<p><img src="media/15771545679019/15802221495986.jpg" alt="" /><br />
通过依赖反转和依赖注入解耦领域层到基础设施层的依赖。但多了一层基础设施的抽象层。</p>
<p><img src="media/15771545679019/15802223804941.jpg" alt="" /><br />
通过DDD的Repository概念，使基础设施抽象层进入领域层。此时用户展现层仍然直接依赖领域层，领域层对外暴露太多细节。</p>
<p><img src="media/15771545679019/15802224971320.jpg" alt="" /><br />
通过引入开放主机服务，隔离开前端对领域层的直接依赖。但此时通过Controller暴露出去的服务仍然过细。</p>
<p><img src="media/15771545679019/15802226450442.jpg" alt="" /><br />
引入应用层，封装如批量查询、请求跳转、跨领域聚合的业务编排等逻辑。通过Facade模式提供高层接口。到此迁移完毕。</p>
<h3><a id="%E6%95%B4%E6%B4%81%E6%9E%B6%E6%9E%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>整洁架构</h3>
<p><img src="media/15771545679019/15802197310420.jpg" alt="" /><br />
Robert Martin 提出的整洁架构</p>
<ul>
<li>层次越靠内的组件依赖的内容越少，处于核心的 Entities 没有任何依赖。</li>
<li>层次越靠内的组件与业务的关系越紧密，因而越不可能形成通用的框架。</li>
<li>Entities 层封装了企业业务规则，准确地讲，它应该是一个面向业务的领域模型。</li>
<li>Use Cases 层是打通内部业务与外部资源的一个通道，因而提供了输出端口（Output Port）与输入端口（Input Port），但它对外的接口展现的其实是应用逻辑，或者说是一个用例。</li>
<li>Gateways、Controllers 与 Presenters 其本质都是适配器（Adapter），用于打通应用业务逻辑与外层的框架和驱动器，实现逻辑的适配以访问外部资源。</li>
<li>系统最外层包括框架和驱动器，负责对接外部资源，不属于系统（仅指限界上下文而言）开发的范畴，但选择这些框架和驱动器，是属于设计决策要考虑的内容。这一层的一些组件甚至与要设计的系统不处于同一个进程边界。</li>
</ul>
<h3><a id="%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>微服务架构</h3>
<p><img src="media/15771545679019/15802207740226.jpg" alt="" /><br />
Martin Fowler的微服务架构</p>
<p>整幅图的架构其实蕴含了两个方向：自顶向下和由内至外。</p>
<ul>
<li>外部请求通过代表协议（Protocol）的 Resources 组件调用 Service Layer、Domain 或 Repositories，如果需要执行持久化任务，则通过 Repositories 将请求委派给 ORM，进而访问网络边界外的数据库。所谓“外部请求”可以是前端 UI 或第三方服务，而 Resource 组件就是我们通常定义的 Controller，对应于上下文映射中的开放主机服务。之所以命名为 Resources，则是因为 REST 架构是一种面向资源的架构，它将服务操作的模型抽象为资源（Resource），这是自顶向下的方向。</li>
<li>若当前微服务需要调用外部服务（External Service），且外部服务籍由 HTTP 协议通信，就需要提供一个 HTTP Client 组件完成对外部服务的调用。为了避免当前微服务对外部服务的强依赖，又或者对客户端的强依赖，需要引入 Gateways 来隔离。事实上，这里的 Gateways 即为上下文映射中的防腐层，这是由内至外的方向。</li>
</ul>
<h2><a id="ddd%E7%9A%84%E4%BB%A3%E7%A0%81%E6%A8%A1%E5%9E%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>DDD的代码模型</h2>
<p>以电商下单业务为例：</p>
<p><img src="media/15771545679019/15803904268910.jpg" alt="" /></p>
<p>代码结构如下所示：</p>
<pre><code class="language-plain_text">ordercontext.infrastructure
    - OrderController
    - OrderMapper
    - EmailSender
    - RabbitEventBus
ordercontext.application
    - OrderAppService
    - NotificationService
    - EventBus
ordercontext.domain
    - OrderRepository
    - PlaceOrderService
    - Order
    - Notification
    - OrderConfirmed
    - NotificationComposer
    - OrderConfirmedComposer
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-12-14T04:08:09-08:00" itemprop="datePublished">12/14/2019</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='architecture-designing.html'>架构设计</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15763252898733.html" itemprop="url">
		人类能否造出真正智能的机器人？</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<p>机器人是什么？<br />
是计算机。<br />
计算机是什么？<br />
冯诺依曼结构的计算机可以抽象为“输入”、“计算”和“输出”三部分。<br />
计算机的智能体现在其扩展能力上。<br />
其输入从最早的打孔纸带扩展到现在的键盘，鼠标、语音，传感器等。<br />
其计算能力可以通过编程来扩展。<br />
其输出从最初的显示器扩展到现在的扬声器、打印机、投影仪等。<br />
机器人的智能体现在，对于不同输入都可以给出“智能”的输出。这个“智能”体现在其处理逻辑会随着处理其他输入而自动升级。表现出会学习的特征。<br />
何为非真正智能的机器人？<br />
不会主动“思考”、“学习”的机器人就不是真正智能的机器人。<br />
如果机器人能够主动的“思考”、“学习”了之后，他和人类有什么区别？<br />
他应该从能力上超过人类。<br />
为了想清楚机器人是否可能最终成为真正“智能”的机器人，我们需要把机器人和人类做一下对比。<br />
然而我认为人类其实也是遵循冯诺依曼结构工作的！<br />
人类刚出生时对于绝大多数输入是没有反应的，即还不具备对输入的计算能力。<br />
随着被动学习，对于固定输入的计算逻辑建立起来了。此时开始模仿，即对于给定的输入，其计算逻辑始终不变，只是越算越快，这是一个熟练过程。<br />
然而人类刚出生也不是对所有输入都没有计算能力的，比如对于疼痛的计算，对于饥饿的计算，对于光线的计算……<br />
随着年龄长大，逐渐体现出对于一些输入会输出嫉妒、气愤、喜欢……<br />
这些其实是人类的基因决定的。<br />
那基因是什么？<br />
其实就是随着人类从远古到现代的进化中积累下来的计算逻辑。比如，人类有攀比心，其实是对于比自己好这个输入的计算，其输出是我要超过他的激素刺激。<br />
正是因为人类天生具备七宗罪的天性基因，才让人类得以主动思考，主动学习。<br />
所以，如果可以破解人类基因，并且给机器人输入这些基因程序，则机器人就可以和人类一样智能。在不给机器人任何输入的情况下，机器人也会基于这个“没有任何输入”的信号，并结合之前的记忆去计算然后表现出机器人在“思考”……</p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-03-23T08:18:09-07:00" itemprop="datePublished">03/23/2019</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='architecture-designing.html'>架构设计</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15533542897748.html" itemprop="url">
		微服务设计规范</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h2><a id="%E4%B8%80%E3%80%81%E5%85%AD%E5%A4%A7%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>一、六大设计原则</h2>
<h3><a id="1-1%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99%EF%BC%88-open-closed-principle-ocp%EF%BC%89" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.1 开闭原则（Open-Closed Principle, OCP）</h3>
<h4><a id="1-1-1%E8%A7%A3%E9%87%8A" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.1.1 解释</h4>
<p>开闭原则由Bertrand Meyer于1988年提出，其定义如下：</p>
<ul>
<li>一个软件实体应当对扩展开放，对修改关闭。即软件实体应尽量在不修改原有代码的情况下进行扩展。</li>
</ul>
<h4><a id="1-1-2%E5%A5%BD%E5%A4%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.1.2 好处</h4>
<p>好处显而易见，不修改源码的情况下进行扩展，对已有逻辑没有影响。</p>
<h4><a id="1-1-3%E4%B8%8D%E9%81%B5%E5%AE%88%E6%9C%89%E4%BB%80%E4%B9%88%E5%9D%8F%E5%A4%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.1.3 不遵守有什么坏处</h4>
<p>随着软件规模越来越大，软件寿命越来越长，若系统设计不满足开闭原则，则维护成本变得越来越大。修一个bug，又引出10个新bug，最终变得无法维护。</p>
<h4><a id="1-1-4%E5%87%BA%E7%8E%B0%E8%BF%9D%E5%8F%8D%E5%8E%9F%E5%88%99%E7%9A%84%E5%8E%9F%E5%9B%A0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.1.4 出现违反原则的原因</h4>
<p>职责不单一是主要影响开闭原则的原因之一；缺乏抽象也会造成开闭原则的破坏。</p>
<h4><a id="1-1-5%E5%AE%9E%E9%99%85%E8%BF%90%E7%94%A8%E4%B8%AD%E7%9A%84%E5%8F%96%E8%88%8D" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.1.5 实际运用中的取舍</h4>
<p>为了满足开闭原则，需要对系统进行抽象化设计，针对具体业务领域识别出抽象层并抽象化是开闭原则的关键。应用层基于上下文参数识别业务场景，针对不同场景选择不同的实现。</p>
<h3><a id="1-2%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC%E5%8E%9F%E5%88%99%EF%BC%88-dependency-inversion-principle-dip%EF%BC%89" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.2 依赖反转原则（Dependency Inversion  Principle, DIP）</h3>
<h4><a id="1-2-1%E8%A7%A3%E9%87%8A" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.2.1 解释</h4>
<p>依赖反转原则是Robert C. Martin在1996年为“C++Reporter”所写的专栏Engineering Notebook的第三篇，后来加入到他在2002年出版的经典著作“Agile Software Development, Principles, Patterns, and Practices”一书中。依赖反转原则定义如下：</p>
<ul>
<li>抽象不应该依赖于细节，细节应当依赖于抽象。换言之，要针对接口编程，而不是针对实现编程。</li>
</ul>
<p>要求我们在程序代码中传递参数时或在关联关系中，尽量引用层次高的抽象层类，即使用接口和抽象类进行变量类型声明、参数类型声明、方法返回类型声明，以及数据类型的转换等，而不要用具体类来做这些事情。</p>
<p>因为正常的依赖顺序是，A依赖B，而为了避免依赖具体实现，引入了抽象层C，使A依赖C，B成为C的具体实现。因为继承、实现关系本身是特殊的依赖关系，所以变成被依赖的实现B反过来依赖C这个抽象层，所以叫依赖反转。</p>
<h4><a id="1-2-2%E5%A5%BD%E5%A4%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.2.2 好处</h4>
<p>依赖反转是实现开闭原则目标的另一个重要手段。</p>
<h4><a id="1-2-3%E4%B8%8D%E9%81%B5%E5%AE%88%E6%9C%89%E4%BB%80%E4%B9%88%E5%9D%8F%E5%A4%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.2.3 不遵守有什么坏处</h4>
<p>少了抽象层，很多设计原则都无法做到，后果可想而知。</p>
<h4><a id="1-2-4%E5%87%BA%E7%8E%B0%E8%BF%9D%E5%8F%8D%E5%8E%9F%E5%88%99%E7%9A%84%E5%8E%9F%E5%9B%A0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.2.4 出现违反原则的原因</h4>
<p>这个原则基本上不会违反，因为有了Spring框架提供的依赖注入。</p>
<h3><a id="1-3%E8%81%8C%E8%B4%A3%E5%8D%95%E4%B8%80%E5%8E%9F%E5%88%99%EF%BC%88-single-responsibility-principle-srp%EF%BC%89" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.3 职责单一原则（Single Responsibility Principle, SRP）</h3>
<h4><a id="1-3-1%E8%A7%A3%E9%87%8A" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.3.1 解释</h4>
<p>把因相同原因而变化的东西聚在一起，把因不同原因而变化的东西分离开来。</p>
<h4><a id="1-3-2%E5%A5%BD%E5%A4%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.3.2 好处</h4>
<p>如果单一职责原则遵守的好，当修改一个功能时，可以显著降低对其他功能的影响。</p>
<h4><a id="1-3-3%E4%B8%8D%E9%81%B5%E5%AE%88%E6%9C%89%E4%BB%80%E4%B9%88%E5%9D%8F%E5%A4%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.3.3 不遵守有什么坏处</h4>
<p>修改一段代码，在实现了一个feature升级的同时，影响了另一个feature的功能。</p>
<h4><a id="1-3-4%E5%87%BA%E7%8E%B0%E8%BF%9D%E5%8F%8D%E5%8E%9F%E5%88%99%E7%9A%84%E5%8E%9F%E5%9B%A0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.3.4 出现违反原则的原因</h4>
<p>职责不单一不是从第一天写代码就开始的，往往是需求变更导致职责拆分后引起的。此时应该将一个方法拆成两个方法，一个类拆成两个类。</p>
<h4><a id="1-3-5%E5%AE%9E%E9%99%85%E8%BF%90%E7%94%A8%E4%B8%AD%E7%9A%84%E5%8F%96%E8%88%8D" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.3.5 实际运用中的取舍</h4>
<p>代码结构并不能随着需求的变更每次都做出重构，会影响团队协作效率，需要把握一个度：</p>
<ul>
<li>只有逻辑足够简单，才可以在方法级别上违反单一职责原则</li>
<li>只有类中方法数量足够少，才可以在方法级别上违反单一职责原则</li>
<li>在职责扩散到我们无法控制的程度之前，立刻对代码进行重构。</li>
</ul>
<h3><a id="1-4%E9%87%8C%E6%B0%8F%E6%9B%BF%E6%8D%A2%E5%8E%9F%E5%88%99%EF%BC%88-liskov-substitution-principle-lsp%EF%BC%89" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.4 里氏替换原则（Liskov Substitution Principle, LSP）</h3>
<h4><a id="1-4-1%E8%A7%A3%E9%87%8A" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.4.1 解释</h4>
<p>里氏代换原则由2008年图灵奖得主、美国第一位计算机科学女博士Barbara Liskov教授和卡内基·梅隆大学Jeannette Wing教授于1994年提出。</p>
<ul>
<li>定义1：如果对每一个类型为 T1的对象 o1，都有类型为 T2 的对象o2，使得以 T1定义的所有程序 P 在所有的对象 o1 都代换成 o2 时，程序 P 的行为没有发生变化，那么类型 T2 是类型 T1 的子类型。</li>
<li>定义2：所有引用父类的地方必须能透明地使用其子类的对象。</li>
</ul>
<p>可以简单理解为：如果在软件中将一个用父类声明的对象，运行期替换成它的某个子类对象，程序没有产生任何错误和异常，则这个子类的实现是符合里氏替换原则的。</p>
<h4><a id="1-4-2%E5%A5%BD%E5%A4%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.4.2 好处</h4>
<p>里氏代换原则是实现开闭原则的重要方式之一。由于使用父类对象的地方都可以使用子类对象，因此在程序中尽量使用父类类型来对对象进行定义，而在运行时再确定其子类类型，用子类对象来替换父类对象。从而实现对原有系统的扩展的同时，不影响原有功能。</p>
<h4><a id="1-3-3%E4%B8%8D%E9%81%B5%E5%AE%88%E6%9C%89%E4%BB%80%E4%B9%88%E5%9D%8F%E5%A4%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.3.3 不遵守有什么坏处</h4>
<p>如果子类集成父类后，又增加了特定的方法，那么只有使用子类来声明对象，这个对象才能使用子类特有的方法，导致后续扩展的时候，必须打开子类来修改代码，没办法替换为父类的其他子类。</p>
<h4><a id="1-3-4%E5%87%BA%E7%8E%B0%E8%BF%9D%E5%8F%8D%E5%8E%9F%E5%88%99%E7%9A%84%E5%8E%9F%E5%9B%A0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.3.4 出现违反原则的原因</h4>
<p>代码设计初期没有考虑将来复杂性的可能，没有预留好扩展点，直接依赖具体实现，没有使用接口隔离实现。</p>
<h4><a id="1-3-5%E5%AE%9E%E9%99%85%E8%BF%90%E7%94%A8%E4%B8%AD%E7%9A%84%E5%8F%96%E8%88%8D" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.3.5 实际运用中的取舍</h4>
<p>软件架构往往是分层的，层与层之间必须使用接口隔离实现，层内的具体业务逻辑如果看不到有多种场景下使用多种实现的可能性，暂时可以直接依赖实现。当出现第二种实现时，立即使用接口隔离。<br />
声明对象时，必须使用集成结构中适合当前场景的某一个层级的抽象来声明，不要直接使用子类来声明对象。如：当前需要一个有序可重复队列，则使用List来声明对象，因为Collection过于抽象，无法表达有序可重复的要求，直接使用ArrayList声明，则将来传入LinkedList对象会出错。</p>
<h3><a id="1-5%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99%EF%BC%88-interface-segregation-principle-isp%EF%BC%89" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.5 接口隔离原则（Interface  Segregation Principle, ISP）</h3>
<h4><a id="1-5-1%E8%A7%A3%E9%87%8A" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.5.1 解释</h4>
<p>使用多个专门的接口，而不使用单一的总接口，即客户端不应该依赖那些它不需要的接口。</p>
<ul>
<li>当把“接口”理解成一个类型所提供的所有方法特征的集合的时候，这就是一种逻辑上的概念，接口的划分将直接带来类型的划分。可以把接口理解成角色，一个接口只能代表一个角色，每个角色都有它特定的一个接口，此时，这个原则可以叫做“角色隔离原则”。</li>
<li>如果把“接口”理解成狭义的特定语言的接口，那么ISP表达的意思是指接口仅仅提供客户端需要的行为，客户端不需要的行为则隐藏起来，应当为客户端提供尽可能小的单独的接口，而不要提供大的总接口。</li>
</ul>
<h4><a id="1-5-2%E5%A5%BD%E5%A4%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.5.2 好处</h4>
<p>容易实现职责单一原则，客户端更容易灵活选择合适的实现，扩展性增强。</p>
<h4><a id="1-5-3%E4%B8%8D%E9%81%B5%E5%AE%88%E6%9C%89%E4%BB%80%E4%B9%88%E5%9D%8F%E5%A4%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.5.3 不遵守有什么坏处</h4>
<p>接口太大，降低了扩展的灵活性。有时，一个接口中仅仅一个方法在不同场景有不同实现，此时增加一个全新的实现，则新的实现中有大部分代码和已有实现是代码重复的。而且客户端面对一个大接口，失去了根据场景灵活组合实现的可能性，只能定制一个全新的实现来适应当前场景，导致复用变得难以实现。</p>
<h4><a id="1-5-4%E5%87%BA%E7%8E%B0%E8%BF%9D%E5%8F%8D%E5%8E%9F%E5%88%99%E7%9A%84%E5%8E%9F%E5%9B%A0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.5.4 出现违反原则的原因</h4>
<p>往往初期系统中接口并不大，随着需求的变化，增加了方法，或增加了角色的职责，而没有及时拆分接口。</p>
<h4><a id="1-5-5%E5%AE%9E%E9%99%85%E8%BF%90%E7%94%A8%E4%B8%AD%E7%9A%84%E5%8F%96%E8%88%8D" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.5.5 实际运用中的取舍</h4>
<p>在使用接口隔离原则时，我们需要注意控制接口的粒度，接口不能太小，如果太小会导致系统中接口泛滥，不利于维护；接口也不能太大，太大的接口将违背接口隔离原则，灵活性较差，使用起来很不方便。一般而言，接口中仅包含为某一类用户定制的方法即可，不应该强迫客户依赖于那些它们不用的方法。</p>
<h3><a id="1-6%E8%BF%AA%E7%B1%B3%E7%89%B9%E6%B3%95%E5%88%99%EF%BC%88-law-of-demeter-lod%EF%BC%89" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.6 迪米特法则（Law of  Demeter, LoD）</h3>
<h4><a id="1-6-1%E8%A7%A3%E9%87%8A" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.6.1 解释</h4>
<p>迪米特法则来自于1987年美国东北大学(Northeastern University)一个名为“Demeter”的研究项目。迪米特法则又称为最少知识原则(LeastKnowledge Principle, LKP)，其定义如下：</p>
<ul>
<li>一个软件实体应当尽可能少地与其他实体发生相互作用。</li>
</ul>
<h4><a id="1-6-2%E5%A5%BD%E5%A4%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.6.2 好处</h4>
<p>如果一个系统符合迪米特法则，那么当其中某一个模块发生修改时，就会尽量少地影响其他模块，扩展会相对容易，这是对软件实体之间通信的限制，迪米特法则要求限制软件实体之间通信的宽度和深度。迪米特法则可降低系统的耦合度，使类与类之间保持松散的耦合关系。</p>
<h4><a id="1-6-3%E4%B8%8D%E9%81%B5%E5%AE%88%E6%9C%89%E4%BB%80%E4%B9%88%E5%9D%8F%E5%A4%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.6.3 不遵守有什么坏处</h4>
<p>不遵守迪米特法则，会使对象间过渡耦合，其结果就是对象间关系过于复杂，而破坏了扩展性和可维护性。</p>
<h4><a id="1-6-4%E5%87%BA%E7%8E%B0%E8%BF%9D%E5%8F%8D%E5%8E%9F%E5%88%99%E7%9A%84%E5%8E%9F%E5%9B%A0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.6.4 出现违反原则的原因</h4>
<p>不要和“陌生人”说话。除以下类型的对象外，其他的都是“陌生人”。缺乏经验的开发，很容易把“陌生人”之间建立起通信关系，使得系统对象间出现不该有的耦合。</p>
<ol>
<li>当前对象本身(this)；</li>
<li>以参数形式传入到当前对象方法中的对象；</li>
<li>当前对象的成员对象；</li>
<li>如果当前对象的成员对象是一个集合，集合中的元素；</li>
<li>当前对象所创建的对象。</li>
</ol>
<p>通常开发容易把本应属于职责边界内的逻辑暴露到外部，调用这段逻辑的客户端代码容易写的过厚，比如客户端依赖n个组件，然后组织n个组件的关系，最后计算出结果，导致客户端和过多的不相关组件通信。其实这n个组件中，很可能大部分逻辑应该封装在几个组件之中，而客户端只需要和少量几个组件通信即可。</p>
<p>当出现连续“.”的方法调用时，比如<code>a.foo().bar()</code>，此时应该警惕是否违反了迪米特法则。</p>
<h4><a id="1-6-5%E5%AE%9E%E9%99%85%E8%BF%90%E7%94%A8%E4%B8%AD%E7%9A%84%E5%8F%96%E8%88%8D" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.6.5 实际运用中的取舍</h4>
<p>实际开发中，为了避免对象间的直接耦合，往往借助“Mediator”、“Proxy”等设计模式，引入中间人，拆开耦合。</p>
<h2><a id="%E4%BA%8C%E3%80%81gof%E7%9A%8423%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>二、GoF的23个设计模式</h2>
<blockquote>
<p>《Design Patterns Elements of Reusable Object-Oriented Software》</p>
</blockquote>
<p>作者介绍：</p>
<ul>
<li>Erich Gamma博士是瑞士苏黎士国际面向对象技术软件中心的技术主管。</li>
<li>Richard Helm博士是澳大利亚悉尼IBM顾问集团公司面向对象技术公司的成员。</li>
<li>Ralph Johnson博士是Urbana-Champaign伊利诺大学计算机科学系成员。</li>
<li>John Vlissides博士是位于纽约Hawthorne的IBN托马斯J.沃森研究中心的研究人员。</li>
</ul>
<h3><a id="2-1%E5%88%9B%E5%BB%BA%E5%9E%8B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>2.1 创建型设计模式</h3>
<p>创建型模式用来解决对象的创建问题，用于解耦对象的使用者和对象的创建过程。</p>
<p>对象的使用者通常不应该包含创建复杂对象的逻辑，否则，对象的创建逻辑的变化会导致对象的使用者需要修改代码。</p>
<ol>
<li>Factory Method Pattern (工厂方法模式)</li>
<li>Abstract Factory Pattern (抽象工厂模式)</li>
<li>Singleton Pattern (单例模式)</li>
<li>Builder Pattern (建造者模式)</li>
<li>Prototype Pattern (原型模式)</li>
</ol>
<h3><a id="2-2%E7%BB%93%E6%9E%84%E5%9E%8B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>2.2 结构型设计模式</h3>
<p>结构型模式用来解决对象间的组合或组装的问题。用于简化客户端代码逻辑，使得客户端依赖的对象可以方便的扩展而不影响客户端。或节省客户端内存。</p>
<p>通常我们希望客户端使用其他对象的时候代码格外精简，优雅，而不是在使用前还要用大量的代码对目标对象做处理。因为这些对目标对象做处理的逻辑很可能发生变化，而这部分逻辑并不是客户端的业务职责。</p>
<ol>
<li>Proxy Pattern (代理模式)</li>
<li>Adapter Pattern (适配器模式)</li>
<li>Decorator Pattern (装饰器模式)</li>
<li>Facade Pattern (门面模式)</li>
<li>Composition Pattern (组合模式)</li>
<li>Flyweight Pattern (享元模式)</li>
<li>Bridge Pattern (桥接模式)</li>
</ol>
<h3><a id="3-3%E8%A1%8C%E4%B8%BA%E5%9E%8B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.3 行为型设计模式</h3>
<p>行为型模式解决的是对象之间交互方式的问题。</p>
<p>不适当的交互方式很容易产生不必要的耦合，使日后扩展受阻，不利于代码复用。</p>
<ol>
<li>Observer Pattern (观察者模式)</li>
<li>Template Method Pattern (模板方法模式)</li>
<li>Strategy Pattern (策略模式)</li>
<li>Chain of Responsibility Pattern (责任链模式)</li>
<li>State Pattern (状态模式)</li>
<li>Iterator Pattern (迭代器模式)</li>
<li>Visitor Pattern (访问者模式)</li>
<li>Memento Pattern (备忘录模式)</li>
<li>Command Pattern (命令模式)</li>
<li>Interpreter Pattern (解释器模式)</li>
<li>Mediator Pattern (中介模式)</li>
</ol>
<h2><a id="%E4%B8%89%E3%80%81the-12-factor-app" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>三、The 12-Factor App</h2>
<p>Originally devised by developers at Heroku, this methodology identifies key principles shared by successful applications.</p>
<blockquote>
<p><a href="https://12factor.net/">The Twelve-Factor App</a></p>
</blockquote>
<h3><a id="3-1-single-codebase%E5%9F%BA%E5%87%86%E4%BB%A3%E7%A0%81" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.1 Single Codebase (基准代码)</h3>
<p>微服务之间不共享代码：多个微服务可以共享一个project，但每个微服务要有一个完整的代码仓库，且微服务之间没有公共的底层代码。</p>
<p>避免一个微服务修改代码影响其他微服务。</p>
<h3><a id="3-2-dependencies%E4%BE%9D%E8%B5%96" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.2 Dependencies (依赖)</h3>
<blockquote>
<p>显式声明依赖关系</p>
</blockquote>
<p>要显式声明依赖，且打包后使微服务自包含；不要假设微服务之外一定存在某个服务而不加依赖声明就去依赖。</p>
<p>避免微服务在不同环境间部署产生差异；使新人上手容易，拉出代码，使用构建工具打包后即可运行。</p>
<h3><a id="3-3-config%E9%85%8D%E7%BD%AE" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.3 Config (配置)</h3>
<blockquote>
<p>在环境中存储配置</p>
</blockquote>
<p>微服务环境相关配置外置。微服务可以从外部拉取对应环境配置，使得微服务在构建之后在不同环境间切换时不用修改构建结果。</p>
<p>避免微服务在不同环境间部署时需要修改源代码引入意外bug，或忘记修改代码中配置导致部署失败。</p>
<h3><a id="3-4-backing-services%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.4 Backing Services (后端服务)</h3>
<blockquote>
<p>把后端服务当做附加资源</p>
</blockquote>
<p>微服务依赖的所有第三方服务都应该被视作一个资源，应该使用地址标识该资源，通过防腐层和依赖反转隔离微服务对外部资源的直接依赖，使得在不同环境只需要修改对应资源地址而不用修改代码即可和第三方服务对接，及时第三方服务的技术实现发生了变化微服务也不用修改代码。</p>
<p>避免在不同环境间部署微服务时，因为第三方服务地址不同或实现不同，版本不同而需要修改代码。</p>
<h3><a id="3-5-build-release-and-run%E6%9E%84%E5%BB%BA%EF%BC%8C%E5%8F%91%E5%B8%83%EF%BC%8C%E8%BF%90%E8%A1%8C" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.5 Build, Release and Run (构建，发布，运行)</h3>
<blockquote>
<p>严格分离构建和运行。</p>
</blockquote>
<p>微服务应该严格区分构建，发布和运行三个阶段。构建是从代码变成二进制的过程，和环境无关，而且不可再变；发布是给二进制加上对应环境的配置，在不同环境长需要使用相同的二进制和不同的环境配置重复发布；运行是在对应环境上启动进程。每个环境有各自的职责，禁止在运行阶段直接修改二进制。</p>
<p>避免微服务在上线过程中不同阶段引入不可预知bug。</p>
<h3><a id="3-6-processes%E8%BF%9B%E7%A8%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.6 Processes (进程)</h3>
<blockquote>
<p>以一个或多个无状态进程运行应用</p>
</blockquote>
<p>微服务的每个实例都应该状态外置，存在缓存或DB中，使微服务实例自身无状态。可以任意水平扩容，负载均衡或代理可以把请求给到任意实例上。</p>
<p>避免无法水平扩容，避免单实例故障后丢失状态。</p>
<h3><a id="3-7-port-binding%E7%AB%AF%E5%8F%A3%E7%BB%91%E5%AE%9A" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.7 Port Binding (端口绑定)</h3>
<blockquote>
<p>通过端口绑定来提供服务</p>
</blockquote>
<p>微服务不应该依赖任何已经存在的服务来对外提供网络服务，应该通过依赖服务提供程序形成自包含，微服务本身就可以对外提供网络服务。</p>
<p>避免网络服务提供能力依赖已存在的其他服务，导致如果其他服务不存在就无法提供网络服务。</p>
<h3><a id="3-8-concurrency%E5%B9%B6%E5%8F%91" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.8 Concurrency (并发)</h3>
<blockquote>
<p>通过进程模型进行扩展</p>
</blockquote>
<p>每个微服务职责单一，不同微服务可根据流量分别水平扩容。微服务不要自己做进程管理。</p>
<p>避免导致微服务扩容的因素过多，造成浪费</p>
<h3><a id="3-9-disposable%E6%98%93%E5%A4%84%E7%90%86" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.9 Disposable (易处理)</h3>
<blockquote>
<p>快速启动和优雅终止可最大化健壮性</p>
</blockquote>
<p>微服务应该追求最小启动时间和优雅的终止服务。优雅的终止服务意味着微服务接收到终止信号后首先关闭网络端口不再接收新的请求，而后继续处理已经接收的请求，最后终止服务。</p>
<p>避免因启动时间太长而影响对突发问题的响应能力。避免在重新调度微服务时由于不优雅终止服务而影响业务。</p>
<h3><a id="3-10-dev-prod-parity%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%92%8C%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83%E7%AD%89%E4%BB%B7" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.10 Dev / Prod Parity (开发环境和线上环境等价)</h3>
<blockquote>
<p>尽可能的保持开发、预发布、线上环境相同</p>
</blockquote>
<p>微服务应该反对在不同环境间使用不同的后端服务。</p>
<p>避免不同的后端服务突然出现的不兼容，导致测试、预发布都正常的代码在线上出现问题。</p>
<h3><a id="3-11-logs%E6%97%A5%E5%BF%97" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.11 Logs (日志)</h3>
<blockquote>
<p>把日志当做事件流</p>
</blockquote>
<p>微服务的日志应当被看作事件流，微服务不要自己管理日志存储，日志应当被日志汇聚底层基础设施统一的处理。</p>
<p>避免登录主机查看日志的麻烦，避免单实例故障导致日志丢失。避免历史事件的不可查询。</p>
<h3><a id="3-12-admin-processes%E7%AE%A1%E7%90%86%E8%BF%9B%E7%A8%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.12  Admin Processes (管理进程)</h3>
<blockquote>
<p>后台管理任务当做一次性进程运行</p>
</blockquote>
<p>后台管理任务的代码随正常业务代码一同升级交付，后台管理任务使用不同的入口，一次性执行，但是基于正常业务的进程执行，两者使用相同的权限</p>
<p>避免管理任务的代码落后于业务代码导致无法使用，避免管理任务的权限超出正常业务进程，导致故障。</p>
<h2><a id="%E5%9B%9B%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1%E5%85%B3%E6%B3%A8%E7%82%B9" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>四、微服务设计关注点</h2>
<h3><a id="4-1%E7%B3%BB%E7%BB%9F%E5%88%86%E5%B1%82" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.1 系统分层</h3>
<ul>
<li>后端微服务使用领域模型驱动开发模式</li>
<li>使用六边形或整洁架构作为代码的分层架构依据</li>
</ul>
<h3><a id="4-2%E6%8C%81%E4%B9%85%E5%B1%82%E8%AE%BE%E8%AE%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.2 持久层设计</h3>
<ul>
<li>禁止全表扫描操作，sql执行要有监控，持续优化慢sql</li>
<li>禁止把大量日志写入关系型数据库</li>
</ul>
<p>根据业务逻辑复杂度，对性能的诉求，可以考虑是用CQRS模式——即读写分离模式。读写分离模式分为数据库层面的读写分离——即主库用来写，从库用来读，和模型层面读写分离。模型层面读写分离针对写场景和读场景可以完全分开设计，模型可以完全不同，以便基于写和读场景的特定需求定制优化，数据库表结构也可以完全不同，甚至写和读场景使用完全不同的数据库产品，如写场景使用RDBMS，读场景使用NoSQL。</p>
<h3><a id="4-3%E8%BF%9C%E7%A8%8B%E9%80%9A%E4%BF%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.3 远程通信</h3>
<ul>
<li>服务注册、发现、负载均衡使用API Gateway，系统间通过API Gateway通信</li>
<li>系统暴露RestfulAPI给其他系统</li>
</ul>
<h3><a id="4-4%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.4 数据一致性</h3>
<ul>
<li>数据变更要同源，禁止同一个数据在两处变更然后同步</li>
<li>分布式系统随时可能出现故障而使一次请求失败，对于系统间通信场景，系统设计时要考虑各个环节异常的处理，如：
<ul>
<li>对方无法正常响应</li>
<li>对方已经接到请求，但是没来得及返回就挂了</li>
<li>接到对方返回，没来的及处理自己挂了</li>
<li>数据已经正常持久化，但是没能及时同步到其他副本，导致从其他副本读数据出现不一致</li>
</ul>
</li>
</ul>
<h3><a id="4-5%E6%80%A7%E8%83%BD" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.5 性能</h3>
<ul>
<li>消耗资源的服务要以非阻塞方式对外提供，接到请求先持久化，然后立即响应，任务执行完通过回调或消息通知方式通知调用方</li>
<li>禁止轮询的方式读取其他系统状态变化，也禁止通过api的方式提供资源状态变化查询服务，应该使用消息通知的方式</li>
<li>消耗资源较多的api要预估资源占用情况，不要一次调用就把内存耗尽，要有防御性设计，给运维留出余地</li>
<li>api设计要支持水平扩展，禁止绑定单台服务器处理任务，任务量上来后要可以通过扩容来降低单机压力</li>
<li>写日志等和主业务逻辑没有强依赖的步骤要做成异步的</li>
<li>对关键系统的写入操作要考虑是否有可能在某些条件下产生写入量突增，要做好预防，以免把关键系统写挂</li>
<li>上线新功能前要预估新功能对资源的需求增量，提前做好扩容准备</li>
</ul>
<h3><a id="4-6%E4%BE%9D%E8%B5%96%E5%8E%9F%E5%88%99" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.6 依赖原则</h3>
<ul>
<li>依赖ID，或枚举，不允许依赖名称</li>
</ul>
<h3><a id="4-7%E9%83%A8%E7%BD%B2%E8%A7%84%E8%8C%83" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.7 部署规范</h3>
<ul>
<li>每个组件一个IP，统一端口，不允许多个组件合部署在一个IP上</li>
</ul>
<h3><a id="4-8%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%BA%A4%E4%BB%98%E4%BB%B6" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.8 架构设计交付件</h3>
<ul>
<li>系统关系图</li>
<li>组件关系图</li>
<li>业务逻辑图</li>
<li>部署架构图</li>
</ul>
<h2><a id="%E4%BA%94%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1%E6%88%90%E7%86%9F%E5%BA%A6%E8%A1%A1%E9%87%8F%E6%A0%87%E5%87%86" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>五、微服务设计成熟度衡量标准</h2>
<table>
<thead>
<tr>
<th>分类</th>
<th>度量项</th>
<th>参考文档</th>
</tr>
</thead>
<tbody>
<tr>
<td>API</td>
<td><div>API Rest成熟度</div><div>(使用Spring-HATEOAS提供可导航的API为4级最高级)</div></td>
<td></td>
</tr>
<tr>
<td>API</td>
<td>客户端代码自动生成</td>
<td></td>
</tr>
<tr>
<td>API</td>
<td>通过Swagger输出API文档</td>
<td></td>
</tr>
<tr>
<td>服务注册</td>
<td>服务自动注册发现</td>
<td></td>
</tr>
<tr>
<td>服务治理</td>
<td>接入API Gateway或Service mesh</td>
<td></td>
</tr>
<tr>
<td>配置</td>
<td>使用分布式动态配置</td>
<td></td>
</tr>
<tr>
<td>分布式事务</td>
<td>利用消息总线实现分布式事务最终一致性</td>
<td></td>
</tr>
</tbody>
</table>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-08-25T22:58:51-07:00" itemprop="datePublished">08/25/2019</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='yi.html'>易经</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15667991314468.html" itemprop="url">
		后天八卦</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<p>乾坎艮震巽离坤兑</p>
<table>
<thead>
<tr>
<th>食指</th>
<th>中指</th>
<th>无名指</th>
</tr>
</thead>
<tbody>
<tr>
<td>巽4</td>
<td>离9</td>
<td>坤2</td>
</tr>
<tr>
<td>震3</td>
<td>5</td>
<td>兑7</td>
</tr>
<tr>
<td>艮8</td>
<td>坎1</td>
<td>乾6</td>
</tr>
</tbody>
</table>
<p>戴九履一，左三右七，二四为肩，六八为足，五居其中</p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-08-25T22:54:04-07:00" itemprop="datePublished">08/25/2019</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='yi.html'>易经</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15667988442443.html" itemprop="url">
		先天八卦</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<pre><code class="language-plain_text">            南
            乾1
        兑2      巽5
   东 离3     9      坎6 西        
        震4      艮7
             坤8
             北
</code></pre>
<p>乾三连、坤六段、震仰盂、艮覆碗、离中虚、坎中满、兑上缺、巽下断</p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2025-08-14T15:53:58-07:00" itemprop="datePublished">08/14/2025</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='dev-ops.html'>DevOps</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="17552120384898.html" itemprop="url">
		Release 分支晋级流程（RBP: Release Branch Promotion）</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>常驻分支：<code>main</code>、<code>release/*</code>（每期一个）、临时 <code>hotfix/*</code>。没有长期 <code>dev</code>。</li>
<li>环境：每个 PR 一个预览环境；Staging 只跟随当前 <code>release/*</code>；Prod 只接“已签名的 release tag”。</li>
<li>构建哲学：<strong>构建一次（在 release 上），Staging 和 Prod 都晋级同一份产物</strong>，绝不重建。</li>
</ul>
<hr />
<h2><a id="sprint%E7%AC%AC-1%E2%80%938%E5%A4%A9%EF%BC%9A%E5%BC%80%E5%8F%91%E6%9C%9F" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sprint 第 1–8 天：开发期</h2>
<ul>
<li>开发分支 → PR → 合 <code>main</code>。</li>
<li><code>main</code> 合并依赖 <strong>merge queue</strong>：单测、契约测、集成测、静态扫描、迁移脚本干跑全绿才合。</li>
<li>每个 PR 自动起<strong>预览环境</strong>给前端/QA点验，通过就销毁。</li>
<li>可选最小开关：全局 Kill Switch + 环境级开关两颗，够用就行。</li>
</ul>
<p>产出：一堆通过所有检查的提交在 <code>main</code>，但还没承诺“本期必上”。</p>
<hr />
<h2><a id="%E7%AC%AC9%E5%A4%A9%EF%BC%9A%E5%86%BB%E7%BB%93%E6%97%A5%EF%BC%88%E5%88%87%E5%80%99%E9%80%89%E7%89%88%E6%9C%AC%EF%BC%89" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>第 9 天：冻结日（切候选版本）</h2>
<ul>
<li>从 <code>main</code> 切出 <code>release/2025.08.S12</code>（名字随你，关键是唯一）。</li>
<li>在 <code>release/*</code> 上<strong>构建一次</strong>产物：镜像/包打不可变 tag（如 <code>app:2025.08.S12-rc.1</code>），记录 digest、SBOM，并<strong>签名</strong>。</li>
<li>部署到 Staging，开始全链路验证（E2E、回放/影子流量、性能冒烟、迁移脚本干跑或小流量实跑）。</li>
</ul>
<p>注意：冻结后 <code>release/*</code> 只收 <strong>fix</strong> 类 PR。带 <code>refactor/deps/migration/public-api-change</code> 标签的一律被 CI 拒收。</p>
<hr />
<h2><a id="%E7%AC%AC10%E2%80%9314%E5%A4%A9%EF%BC%9A%E6%94%B6%E6%95%9B%E6%9C%9F%EF%BC%88%E5%8F%AA%E6%94%B6%E4%BF%AE%EF%BC%89" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>第 10–14 天：收敛期（只收修）</h2>
<ul>
<li>
<p>需要修的 bug：</p>
<ul>
<li>方案 A（推荐）：在 <code>main</code> 修，打 <code>backport:release/2025.08.S12</code> 标签，机器人自动 <strong>cherry-pick -x</strong> 回 <code>release/*</code>，重跑 Staging 验证。</li>
<li>方案 B（紧急）：直接在 <code>release/*</code> 修，同时 <strong>反向合回</strong> <code>main</code>，保持主线干净。</li>
</ul>
</li>
<li>
<p>若发现“混了重构”的提交：在 <code>release/*</code> 上 <code>git revert -m 1 &lt;merge-commit&gt;</code>，重出 <code>rc.2</code>，继续测。<strong>主线不动</strong>。</p>
</li>
<li>
<p>DB 迁移遵循 expand/contract：</p>
<ul>
<li>expand（加列/兼容写）只能在前一班或本班早期就位；</li>
<li>contract（删旧列/切流）排到下一班。冻结期不做 contract。</li>
</ul>
</li>
</ul>
<hr />
<h2><a id="%E5%8F%91%E7%89%88%E6%97%A5%EF%BC%9A%E6%99%8B%E7%BA%A7%EF%BC%8C%E4%B8%8D%E9%87%8D%E5%BB%BA" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>发版日：晋级，不重建</h2>
<ul>
<li>给 <code>release/*</code> 当前 commit 打<strong>签名 tag</strong>：<code>v2025.08.S12</code>，指向已在 Staging 验证过的<strong>同一产物</strong>。</li>
<li>Prod 流水线只接受这个签名 tag，直接<strong>晋级</strong>同一 digest 到生产。</li>
<li>打产物不可变别名：<code>app:2025.08.S12</code> → 指向那个 digest。记录 SBOM、变更单、审批人，审计闭环。</li>
</ul>
<hr />
<h2><a id="hotfix%EF%BC%9A%E4%B8%A4%E5%88%97%E8%BD%A6%E4%BA%92%E4%B8%8D%E6%B1%A1%E6%9F%93" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hotfix：两列车互不污染</h2>
<ul>
<li>
<p>从“线上最近一次<strong>生产 tag</strong>”切 <code>hotfix/XYZ</code>，修完：</p>
<ol>
<li>在 hotfix 分支构建 <code>v2025.08.S12-p1</code>，可先在短暂 Staging 或金丝雀验证；</li>
<li>晋级到生产；</li>
<li><strong>回填</strong>到正在维护的 <code>release/*</code> 和 <code>main</code>。</li>
</ol>
</li>
<li>
<p>不去动任何“下一班”的 <code>release/*</code>。候选车和现网车各开各的。</p>
</li>
</ul>
<hr />
<h2><a id="%E5%9B%9E%E6%BB%9A%EF%BC%9A%E4%B8%80%E9%94%AE%E9%80%80%E5%9B%9E%E4%B8%8A%E4%B8%AA%E7%89%88%E6%9C%AC" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>回滚：一键退回上个版本</h2>
<ul>
<li>直接把生产<strong>晋级回上一个签名 tag</strong>（同一 digest）。</li>
<li>若需要“功能层面”止血，拉下 Kill Switch。</li>
<li>DB 回滚只在使用了可逆脚本时执行；否则依赖 expand/contract 的前向兼容性先熬过去。</li>
</ul>
<hr />
<h2><a id="%E6%9D%83%E9%99%90%E4%B8%8E%E6%8A%A4%E6%A0%8F%EF%BC%88%E9%98%B2%E4%BD%9C%E6%AD%BB%E4%B8%89%E4%BB%B6%E5%A5%97%EF%BC%89" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>权限与护栏（防作死三件套）</h2>
<ul>
<li>生产流水线的<strong>部署来源</strong>只允许 <code>release/*</code> 的签名 tag，技术上禁止从任意分支 HEAD 部署。</li>
<li>冻结后 <code>release/*</code> 的 CI Gate：仅放 <code>type=fix</code> 且触达面与行数低于阈值的 PR，其他一律 fail。</li>
<li><code>main</code> 的合并必须经 merge queue，合并后<strong>不会</strong>自动部署到 Staging；Staging 只吃 <code>release/*</code>。</li>
</ul>
<hr />
<h2><a id="%E6%9C%80%E5%B0%8F%E5%B7%A5%E5%85%B7%E6%B8%85%E5%8D%95%EF%BC%88%E5%A4%9F%E7%94%A8%E5%8D%B3%E5%8F%AF%EF%BC%89" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>最小工具清单（够用即可）</h2>
<ul>
<li>镜像/包签名与 SBOM：cosign/slsa + 你们的制品库。</li>
<li>Backport 机器人：现成的 backport-bot 或 GitHub Actions 模板。</li>
<li>影子流量/回放：一条读路径回放管道；写请求在 Staging NOP。</li>
<li>开关：自建 DB 表都行，至少有“全局关”和“按环境关”。</li>
</ul>
<hr />
<h2><a id="%E5%B8%B8%E8%A7%81%E6%83%85%E6%99%AF%E5%AF%B9%E7%85%A7" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>常见情景对照</h2>
<ul>
<li>“第 11 天线上爆 P1”：按 hotfix 流走，不碰下一班 <code>release/*</code>；发完补回。</li>
<li>“冻结后发现某 PR 混重构”：在 <code>release/*</code> 上 revert，另起干净 fix；<code>main</code> 不动。</li>
<li>“A/B 契约要成对上”：Gate 强制 A、B 都绿才放 <code>release/*</code>，没齐就下一班。</li>
<li>“审计要证据链”：产物 digest、签名 tag、Staging 与 Prod 的部署记录一致，截图即证。</li>
</ul>
<p>就这么简单：<strong>主线做演化，release 做交付，产物做真相</strong>。别再把 prod 当工作台，别再让提交当发布单位。你要的是确定性，不是惊喜。</p>


			
			
		</div>

	</article>
  

</div>
<nav id="pagenavi">
	 <a class="prev" href="all_1.html">Prev</a>  
	 <a class="next" href="all_3.html">Next</a> 
	<div class="center"><a href="archives.html">Blog Archives</a></div>

</nav>

</div>



        </div>
			<footer id="footer" class="inner">Copyright &copy; 2014
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; 
Theme by <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
      </footer>
		</div>
	</div>


<script>(n=>{"use strict";let s,r,e;const l=["cdn.jsdelivr.net","fastly.jsdelivr.net","gcore.jsdelivr.net","cdn.zenless.top","testingcf.jsdelivr.net"],t="//",i=l[0],o=Date.now(),a=2e3,c="jsdelivr-auto-fallback",f="/gh/PipecraftNet/jsdelivr-auto-fallback@main/empty.css?",d=e=>e&&e.includes(t+i),m=e=>e.replace(t+i,t+s),u=window.setTimeout,v=n.querySelectorAll.bind(n),b=()=>{let e,t;for(e of v('link[rel="stylesheet"]'))t=e.href,d(t)&&!t.includes(f)&&(e.href=m(t));for(e of v("script"))if(t=e.src,d(t)){const s=n.createElement("script");s.src=m(t),e.defer=!0,e.src="",e.before(s),e.remove()}for(e of v("img"))t=e.src,d(t)&&(e.src="",e.src=m(t));for(e of v("*[style]"))t=e.getAttribute("style"),d(t)&&e.setAttribute("style",m(t));for(e of v("style"))t=e.innerHTML,d(t)&&(e.innerHTML=m(t))},h=()=>{!e&&r&&s&&(console.warn(i+" is not available. Use "+s),e=!0,u(b,0),u(b,20),setInterval(b,500))},g=(()=>{try{return Object.assign({},JSON.parse(localStorage.getItem(c)||"{}"))}catch{return{}}})(),y=()=>{g.time=o,g.failed=!1,g.fastNode=null;for(const t of l)((e,t)=>{let s;const r=n.createElement("link"),l=e=>{s&&(clearTimeout(s),s=0,e||(r.href="data:text/css;base64,"),r.remove(),t(e))};s=u(l,a),r.addEventListener("error",()=>l(!1)),r.addEventListener("load",()=>l(!0)),r.rel="stylesheet",r.text="text/css",r.href=e+f+o,n.head.insertAdjacentElement("afterbegin",r)})("https://"+t,e=>{e||t!==i||(r=!0,g.failed=!0),e&&!s&&(s=t),e&&!g.fastNode&&(g.fastNode=t),h()});u(()=>{r&&!s&&(s=l[1],h()),localStorage.setItem(c,JSON.stringify(g))},a+100)};if(g.time&&o-g.time<36e5&&g.failed&&g.fastNode)r=!0,s=g.fastNode,h(),u(y,1e3);else if(n.head)y();else{const j=new MutationObserver(()=>{n.head&&(j.disconnect(),y())});j.observe(n,{childList:!0,subtree:!0})}})(document);</script>
<style>.mweb-charts{background:#fff;}
body{ box-sizing: border-box;
    margin: 0 auto;}
@media print{
    pre, code, pre code {
     overflow: visible !important;
     white-space: pre-wrap !important;       /* css-3 */
     white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
     white-space: -pre-wrap !important;      /* Opera 4-6 */
     white-space: -o-pre-wrap !important;    /* Opera 7 */
     word-wrap: break-word !important;       /* Internet Explorer 5.5+ */
    }
    html,body{margin:0;padding:4px;}
}



div.code-toolbar {
  position: relative;
}

div.code-toolbar > .toolbar {
  position: absolute;
  z-index: 10;
  top: .3em;
  right: .2em;
  transition: opacity 0.3s ease-in-out;
  opacity: 0;
}

div.code-toolbar:hover > .toolbar {
  opacity: 1;
}

/* Separate line b/c rules are thrown out if selector is invalid.
   IE11 and old Edge versions don't support :focus-within. */
div.code-toolbar:focus-within > .toolbar {
  opacity: 1;
}

div.code-toolbar > .toolbar > .toolbar-item {
  display: inline-block;
}

div.code-toolbar > .toolbar > .toolbar-item > a {
  cursor: pointer;
}

div.code-toolbar > .toolbar > .toolbar-item > button {
  background: none;
  border: 0;
  color: inherit;
  font: inherit;
  line-height: normal;
  overflow: visible;
  padding: 0;
  -webkit-user-select: none; /* for button */
  -moz-user-select: none;
  -ms-user-select: none;
}

div.code-toolbar > .toolbar > .toolbar-item > a,
div.code-toolbar > .toolbar > .toolbar-item > button,
div.code-toolbar > .toolbar > .toolbar-item > span {
  color: inherit;
  font-size: .8em;
  padding: 4px .5em;
  background: #f5f2f0;
  background: rgba(224, 224, 224, 0.4);
  box-shadow: 0 2px 0 0 rgba(0,0,0,0.2);
  border-radius: .5em;
}

div.code-toolbar > .toolbar > .toolbar-item > a:hover,
div.code-toolbar > .toolbar > .toolbar-item > a:focus,
div.code-toolbar > .toolbar > .toolbar-item > button:hover,
div.code-toolbar > .toolbar > .toolbar-item > button:focus,
div.code-toolbar > .toolbar > .toolbar-item > span:hover,
div.code-toolbar > .toolbar > .toolbar-item > span:focus {
  color: inherit;
  text-decoration: none;
}
</style><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script><script>!function(){if("undefined"!=typeof Prism&&"undefined"!=typeof document){var e=[],t={},n=function(){};Prism.plugins.toolbar={};var a=Prism.plugins.toolbar.registerButton=function(n,a){var r;r="function"==typeof a?a:function(e){var t;return"function"==typeof a.onClick?((t=document.createElement("button")).type="button",t.addEventListener("click",(function(){a.onClick.call(this,e)}))):"string"==typeof a.url?(t=document.createElement("a")).href=a.url:t=document.createElement("span"),a.className&&t.classList.add(a.className),t.textContent=a.text,t},n in t?console.warn('There is a button with the key "'+n+'" registered already.'):e.push(t[n]=r)},r=Prism.plugins.toolbar.hook=function(a){var r=a.element.parentNode;var l=a.element.classList;if(l.contains('language-mermaid') || l.contains('language-echarts') || l.contains('language-plantuml')){return;} if(r&&/pre/i.test(r.nodeName)&&!r.parentNode.classList.contains("code-toolbar")){var o=document.createElement("div");o.classList.add("code-toolbar"),r.parentNode.insertBefore(o,r),o.appendChild(r);var i=document.createElement("div");i.classList.add("toolbar");var l=e,d=function(e){for(;e;){var t=e.getAttribute("data-toolbar-order");if(null!=t)return(t=t.trim()).length?t.split(/\s*,\s*/g):[];e=e.parentElement}}(a.element);d&&(l=d.map((function(e){return t[e]||n}))),l.forEach((function(e){var t=e(a);if(t){var n=document.createElement("div");n.classList.add("toolbar-item"),n.appendChild(t),i.appendChild(n)}})),o.appendChild(i)}};a("label",(function(e){var t=e.element.parentNode;if(t&&/pre/i.test(t.nodeName)&&t.hasAttribute("data-label")){var n,a,r=t.getAttribute("data-label");try{a=document.querySelector("template#"+r)}catch(e){}return a?n=a.content:(t.hasAttribute("data-url")?(n=document.createElement("a")).href=t.getAttribute("data-url"):n=document.createElement("span"),n.textContent=r),n}})),Prism.hooks.add("complete",r)}}();</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/toolbar/prism-toolbar.min.css"><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script><style>div.code-toolbar > .toolbar > .toolbar-item > a, div.code-toolbar > .toolbar > .toolbar-item > button, div.code-toolbar > .toolbar > .toolbar-item > span {padding: 4px .5em; background: #f5f2f0; background: rgba(224, 224, 224, 0.4);}</style><script>window.MathJax = {     tex: { tags: 'ams', displayMath: [ ['\\[', '\\]'] ] } ,     startup: {     pageReady() {       return MathJax.startup.defaultPageReady().then(function () {          window.mweb_mathjax_ready_val = 'yes';          if(window.mweb_mathjax_ready !== undefined){ mweb_mathjax_ready(); }       });     }   }};document.addEventListener('DOMContentLoaded', function(event) {    if (typeof Prism != 'undefined') {         Prism.highlightAll();     }});window.mweb_mathjax_ready_val = '';function theMWebMathJaxRenderIsReady(key){ return window.mweb_mathjax_ready_val; }</script><script>window.MathJax = { tex: { tags: 'ams', displayMath: [ ['\\[', '\\]'] ] } }; </script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"></script>

<style type="text/css">
figure{margin: 1em 0;padding: 0;}
  figcaption{text-align:center;}

/* PrismJS 1.14.0
https://prismjs.com/download.html#themes=prism-coy&languages=markup+css+clike+javascript */
/**
 * prism.js Coy theme for JavaScript, CoffeeScript, CSS and HTML
 * Based on https://github.com/tshedor/workshop-wp-theme (Example: http://workshop.kansan.com/category/sessions/basics or http://workshop.timshedor.com/category/sessions/basics);
 * @author Tim  Shedor
 */

code[class*="language-"],
pre[class*="language-"] {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  position: relative;
  margin: .5em 0;
  overflow: visible;
  padding: 0;
}
pre[class*="language-"]>code {
  position: relative;
  border-left: 10px solid #358ccb;
  box-shadow: -1px 0px 0px 0px #358ccb, 0px 0px 0px 1px #dfdfdf;
  background-color: #fdfdfd;
  background-image: linear-gradient(transparent 50%, rgba(69, 142, 209, 0.04) 50%);
  background-size: 3em 3em;
  background-origin: content-box;
  background-attachment: local;
}

code[class*="language"] {
  max-height: inherit;
  height: inherit;
  padding: 0 1em;
  display: block;
  overflow: auto;
}

/* Margin bottom to accomodate shadow */
:not(pre) > code[class*="language-"],
pre[class*="language-"] {
  background-color: #fdfdfd;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  margin-bottom: 1em;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  position: relative;
  padding: .2em;
  border-radius: 0.3em;
  color: #c92c2c;
  border: 1px solid rgba(0, 0, 0, 0.1);
  display: inline;
  white-space: normal;
}

pre[class*="language-"]:before,
pre[class*="language-"]:after {
  content: '';
  z-index: -2;
  display: block;
  position: absolute;
  bottom: 0.75em;
  left: 0.18em;
  width: 40%;
  height: 20%;
  max-height: 13em;
  box-shadow: 0px 13px 8px #979797;
  -webkit-transform: rotate(-2deg);
  -moz-transform: rotate(-2deg);
  -ms-transform: rotate(-2deg);
  -o-transform: rotate(-2deg);
  transform: rotate(-2deg);
}

:not(pre) > code[class*="language-"]:after,
pre[class*="language-"]:after {
  right: 0.75em;
  left: auto;
  -webkit-transform: rotate(2deg);
  -moz-transform: rotate(2deg);
  -ms-transform: rotate(2deg);
  -o-transform: rotate(2deg);
  transform: rotate(2deg);
}

.token.comment,
.token.block-comment,
.token.prolog,
.token.doctype,
.token.cdata {
  color: #7D8B99;
}

.token.punctuation {
  color: #5F6364;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.function-name,
.token.constant,
.token.symbol,
.token.deleted {
  color: #c92c2c;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.function,
.token.builtin,
.token.inserted {
  color: #2f9c0a;
}

.token.operator,
.token.entity,
.token.url,
.token.variable {
  color: #a67f59;
  background: rgba(255, 255, 255, 0.5);
}

.token.atrule,
.token.attr-value,
.token.keyword,
.token.class-name {
  color: #1990b8;
}

.token.regex,
.token.important {
  color: #e90;
}

.language-css .token.string,
.style .token.string {
  color: #a67f59;
  background: rgba(255, 255, 255, 0.5);
}

.token.important {
  font-weight: normal;
}

.token.bold {
  font-weight: bold;
}
.token.italic {
  font-style: italic;
}

.token.entity {
  cursor: help;
}

.namespace {
  opacity: .7;
}

@media screen and (max-width: 767px) {
  pre[class*="language-"]:before,
  pre[class*="language-"]:after {
    bottom: 14px;
    box-shadow: none;
  }

}

/* Plugin styles */
.token.tab:not(:empty):before,
.token.cr:before,
.token.lf:before {
  color: #e0d7d1;
}

/* Plugin styles: Line Numbers */
pre[class*="language-"].line-numbers.line-numbers {
  padding-left: 0;
}

pre[class*="language-"].line-numbers.line-numbers code {
  padding-left: 3.8em;
}

pre[class*="language-"].line-numbers.line-numbers .line-numbers-rows {
  left: 0;
}

/* Plugin styles: Line Highlight */
pre[class*="language-"][data-line] {
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 0;
}
pre[data-line] code {
  position: relative;
  padding-left: 4em;
}
pre .line-highlight {
  margin-top: 0;
}

pre[class*="language-"].line-numbers {
    position: relative;
    padding-left: 3.8em;
    counter-reset: linenumber;
}

pre[class*="language-"].line-numbers > code {
    position: relative;
    white-space: inherit;
}

.line-numbers .line-numbers-rows {
    position: absolute;
    pointer-events: none;
    top: 0;
    font-size: 100%;
    left: -3.8em;
    width: 3em; /* works for line-numbers below 1000 lines */
    letter-spacing: -1px;
    border-right: 1px solid #999;

    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;

}

    .line-numbers-rows > span {
        pointer-events: none;
        display: block;
        counter-increment: linenumber;
    }

        .line-numbers-rows > span:before {
            content: counter(linenumber);
            color: #999;
            display: block;
            padding-right: 0.8em;
            text-align: right;
        }

</style>

<script type="text/javascript">
    var disqus_shortname = 'luckyowl'; 

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<script type="text/javascript">
var disqus_shortname = 'luckyowl'; 

(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = '//' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
  
    


</body>
</html>